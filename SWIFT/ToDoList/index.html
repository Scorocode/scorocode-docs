
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.ico">
      
      <meta name="generator" content="mkdocs+mkdocs-material#1.0.3">
    
    
      
        <title>Список задач (iOs) - Документация Scorocode</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-facb31f4a3.js"></script>
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-f3ab63f78a.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-02ce7adcc2.palette.css">
      
      
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="blue" data-md-color-accent="light-blue">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Документация Scorocode" class=" md-logo  md-header-nav__button">
          
            <img src="../../logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Примеры приложений
                </span>
              
            
            Список задач (iOs)
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            
          </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <i class=" md-logo  md-nav__button">
      
        <img src="../../logo.png">
      
    </i>
    Документация Scorocode
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Scorocode
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-1">
        Scorocode
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../.." title="Общие сведения" class="md-nav__link">
        Общие сведения
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../main/main1/" title="Начало работы" class="md-nav__link">
        Начало работы
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../main/main2/" title="Личный кабинет" class="md-nav__link">
        Личный кабинет
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app/" title="Работа с приложением" class="md-nav__link">
        Работа с приложением
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app1/" title="Аналитика приложения" class="md-nav__link">
        Аналитика приложения
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app2/" title="Данные приложения" class="md-nav__link">
        Данные приложения
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app3/" title="Индексы" class="md-nav__link">
        Индексы
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app4/" title="Триггеры" class="md-nav__link">
        Триггеры
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app5/" title="Серверный код приложения" class="md-nav__link">
        Серверный код приложения
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../app/bots/" title="Боты Telegram" class="md-nav__link">
        Боты Telegram
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app6/" title="Настройки приложения" class="md-nav__link">
        Настройки приложения
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      HTTP API
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-2">
        HTTP API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/appapi/" title="Работа с приложением" class="md-nav__link">
        Работа с приложением
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi1/" title="Пользователи" class="md-nav__link">
        Пользователи
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi2/" title="Данные" class="md-nav__link">
        Данные
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi3/" title="Файлы" class="md-nav__link">
        Файлы
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi4/" title="Сообщения" class="md-nav__link">
        Сообщения
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi5/" title="Скрипты" class="md-nav__link">
        Скрипты
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi6/" title="Статистика" class="md-nav__link">
        Статистика
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      JavaScript SDK
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-3">
        JavaScript SDK
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/javascript/" title="JavaScript SDK" class="md-nav__link">
        JavaScript SDK
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode/" title="Scorocode" class="md-nav__link">
        Scorocode
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.Object/" title="Scorocode.Object" class="md-nav__link">
        Scorocode.Object
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.Query/" title="Scorocode.Query" class="md-nav__link">
        Scorocode.Query
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.UpdateOps/" title="Scorocode.UpdateOps" class="md-nav__link">
        Scorocode.UpdateOps
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.User/" title="Scorocode.User" class="md-nav__link">
        Scorocode.User
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.Messenger/" title="Scorocode.Messenger" class="md-nav__link">
        Scorocode.Messenger
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.CloudCode/" title="Scorocode.CloudCode" class="md-nav__link">
        Scorocode.CloudCode
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.Bot/" title="Scorocode.Bot" class="md-nav__link">
        Scorocode.Bot
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.Websocket/" title="Scorocode.WebSocket" class="md-nav__link">
        Scorocode.WebSocket
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.System/" title="Scorocode.System" class="md-nav__link">
        Scorocode.System
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      SWIFT SDK (iOs, Mac OS)
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-4">
        SWIFT SDK (iOs, Mac OS)
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../SWIFT/" title="SWIFT SDK" class="md-nav__link">
        SWIFT SDK
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SC/" title="SC" class="md-nav__link">
        SC
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SCValue/" title="SCValue" class="md-nav__link">
        SCValue
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SCObject/" title="SCObject" class="md-nav__link">
        SCObject
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SCQuery/" title="SCQuery" class="md-nav__link">
        SCQuery
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SCUpdate/" title="SCUpdate" class="md-nav__link">
        SCUpdate
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SCUser/" title="SCUser" class="md-nav__link">
        SCUser
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SCMessage/" title="SCMessage" class="md-nav__link">
        SCMessage
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SCScript/" title="SCScript" class="md-nav__link">
        SCScript
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SCBot/" title="SCBot" class="md-nav__link">
        SCBot
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SCCollection/" title="SCCollection" class="md-nav__link">
        SCCollection
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../SCFolder/" title="SCFolder" class="md-nav__link">
        SCFolder
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../WebSocket/" title="WebSocket" class="md-nav__link">
        WebSocket
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Java SDK (Android)
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-5">
        Java SDK (Android)
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/Java/" title="Java SDK" class="md-nav__link">
        Java SDK
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/ScorocodeSDK/" title="Класс ScorocodeSDK" class="md-nav__link">
        Класс ScorocodeSDK
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/Document/" title="Класс Document" class="md-nav__link">
        Класс Document
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/Update/" title="Класс Update" class="md-nav__link">
        Класс Update
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/User/" title="Класс User" class="md-nav__link">
        Класс User
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/Query/" title="Класс Query" class="md-nav__link">
        Класс Query
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/Script/" title="Класс Script" class="md-nav__link">
        Класс Script
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/Message/" title="Класс Message" class="md-nav__link">
        Класс Message
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/WebSocket/" title="Класс WebSocket" class="md-nav__link">
        Класс WebSocket
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/ApplicationInfo/" title="Класс ApplicationInfo" class="md-nav__link">
        Класс ApplicationInfo
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/Bot/" title="Класс Bot" class="md-nav__link">
        Класс Bot
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/Collections/" title="Класс Collections" class="md-nav__link">
        Класс Collections
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/Folders/" title="Класс Folders" class="md-nav__link">
        Класс Folders
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/ScorocodeScript/" title="Класс ScorocodeScript" class="md-nav__link">
        Класс ScorocodeScript
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Примеры приложений
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-6">
        Примеры приложений
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../Java/Storehouse/" title="Склад (Android)" class="md-nav__link">
        Склад (Android)
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Список задач (iOs)
      </label>
    
    <a href="./" title="Список задач (iOs)" class="md-nav__link md-nav__link--active">
      Список задач (iOs)
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" title="Структура данных приложения:" class="md-nav__link">
    Структура данных приложения:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" title="Общие функции приложения" class="md-nav__link">
    Общие функции приложения
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scorocodesdk" title="Инициализация ScorocodeSDK" class="md-nav__link">
    Инициализация ScorocodeSDK
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" title="Стартовый экран приложения." class="md-nav__link">
    Стартовый экран приложения.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" title="Экран регистрации нового пользователя" class="md-nav__link">
    Экран регистрации нового пользователя
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" title="Экран списка задач." class="md-nav__link">
    Экран списка задач.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" title="Экран с деталями задачи / создания новой задачи." class="md-nav__link">
    Экран с деталями задачи / создания новой задачи.
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" title="Скрипт оповещения постановщика задач о просроченных сроках" class="md-nav__link">
    Скрипт оповещения постановщика задач о просроченных сроках
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" title="Структура данных приложения:" class="md-nav__link">
    Структура данных приложения:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" title="Общие функции приложения" class="md-nav__link">
    Общие функции приложения
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scorocodesdk" title="Инициализация ScorocodeSDK" class="md-nav__link">
    Инициализация ScorocodeSDK
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" title="Стартовый экран приложения." class="md-nav__link">
    Стартовый экран приложения.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" title="Экран регистрации нового пользователя" class="md-nav__link">
    Экран регистрации нового пользователя
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" title="Экран списка задач." class="md-nav__link">
    Экран списка задач.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" title="Экран с деталями задачи / создания новой задачи." class="md-nav__link">
    Экран с деталями задачи / создания новой задачи.
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" title="Скрипт оповещения постановщика задач о просроченных сроках" class="md-nav__link">
    Скрипт оповещения постановщика задач о просроченных сроках
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
              
                
                <p><a name="ToDoList"></a></p>
<h1 id="_1">Приложение "Список задач"</h1>
<p>Данная документация содержит описание демонстрационного приложения "Список задач". Исходный код приложения доступен в репозитории <a href="https://github.com/Scorocode/scorocode-SDK-swift/tree/master">https://github.com/Scorocode/scorocode-SDK-swift/tree/master</a>.</p>
<p>Данное приложение позволяет ставить задачи сотрудникам и контролировать их выполнение. Функции прложения:</p>
<ol>
<li>Зарегистрировать нового пользователя в БД приложения</li>
<li>Провести аутентификацию пользователя приложения</li>
<li>Провести деаутентификацию пользователя приложения.</li>
<li>Посмотреть список задач</li>
<li>Добавить задачу</li>
<li>Удалить задачу</li>
<li>Посмотреть подробную информацию о задаче</li>
<li>Изменить параметры задачи</li>
<li>Оставлять комментарии к задаче от постановщика и от исполнителя задачи</li>
<li>Назначать исполнителя задачи и срок выполнения</li>
<li>Проставлять статус задачи от исполнителя, закрывать задачу постановщиком</li>
<li>Оповестить поставновщика задач о выполнении задачи push-собщением</li>
<li>Оповестить исполнителя задачи о закрытии/доработке задачи push-собщением</li>
<li>Оповестить постановщика задач о просроченном сроке выполнения задачи исполнителем push-собщением</li>
<li>Смотреть историю изменения/выполнения задачи</li>
</ol>
<h2 id="_2">Структура данных приложения:</h2>
<p>Создана коллекция <code>tasks</code> со следующими полями:</p>
<ol>
<li>Closed (String)</li>
<li>Done (String)</li>
<li>bossComment (String)</li>
<li>closeDate (Date)</li>
<li>comment (String)</li>
<li>detailed (String)</li>
<li>name (String)</li>
<li>user (Pointer)</li>
</ol>
<p>Создана коллекция <code>history</code> со следующими полями:</p>
<ol>
<li>field (String)</li>
<li>task (Pointer)</li>
<li>value (String)</li>
</ol>
<p>В системную коллекцию <code>Roles</code> добавлены 3 документа со следующими значениями поля <code>name</code> соответственно:</p>
<ol>
<li>boss</li>
<li>manager</li>
</ol>
<h3 id="_3">Общие функции приложения</h3>
<p>Для оповещения пользователя добавим extension к базовому классу <code>UIViewController</code> показа alert-сообщения с заголовком, текстом сообщения и выполняемым действием при закрытии сообщения:</p>
<div class="codehilite"><pre><span></span><span class="c1">// Show alert with title and message and execute action</span>
<span class="kd">extension</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="p">(()</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)?)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">alert</span> <span class="p">=</span> <span class="bp">UIAlertController</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="n">preferredStyle</span><span class="p">:</span> <span class="p">.</span><span class="n">alert</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">ok</span> <span class="p">=</span> <span class="bp">UIAlertAction</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="k">default</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">action</span> <span class="k">in</span>
            <span class="n">completion</span><span class="p">?()</span>
        <span class="p">}</span>
        <span class="n">alert</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
        <span class="n">present</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Для автоматического увеличения/уменьшения view текущего viewcontroller'а при показе системной клавиатуры добавим следующий extension:</p>
<p><div class="codehilite"><pre><span></span><span class="kd">extension</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="c1">// register</span>
    <span class="kd">func</span> <span class="nf">setupViewResizerOnKeyboardShown</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">NotificationCenter</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span>
                                               <span class="n">selector</span><span class="p">:</span> <span class="p">#</span><span class="n">selector</span><span class="p">(</span><span class="bp">UIViewController</span><span class="p">.</span><span class="n">keyboardWillShowForResizing</span><span class="p">),</span>
                                               <span class="n">name</span><span class="p">:</span> <span class="n">Notification</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">UIKeyboardWillShow</span><span class="p">,</span>
                                               <span class="n">object</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="n">NotificationCenter</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span>
                                               <span class="n">selector</span><span class="p">:</span> <span class="p">#</span><span class="n">selector</span><span class="p">(</span><span class="bp">UIViewController</span><span class="p">.</span><span class="n">keyboardWillHideForResizing</span><span class="p">),</span>
                                               <span class="n">name</span><span class="p">:</span> <span class="n">Notification</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">UIKeyboardWillHide</span><span class="p">,</span>
                                               <span class="n">object</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// resize view on show keyboard</span>
    <span class="kd">func</span> <span class="nf">keyboardWillShowForResizing</span><span class="p">(</span><span class="n">notification</span><span class="p">:</span> <span class="n">Notification</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">keyboardSize</span> <span class="p">=</span> <span class="p">(</span><span class="n">notification</span><span class="p">.</span><span class="n">userInfo</span><span class="p">?[</span><span class="n">UIKeyboardFrameEndUserInfoKey</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="bp">NSValue</span><span class="p">)?.</span><span class="n">cgRectValue</span><span class="p">,</span>
            <span class="kd">let</span> <span class="nv">window</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">window</span><span class="p">?.</span><span class="n">frame</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span> <span class="p">=</span> <span class="bp">CGRect</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
                                     <span class="n">y</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
                                     <span class="n">width</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
                                     <span class="n">height</span><span class="p">:</span> <span class="n">window</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">window</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">keyboardSize</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;We&#39;re showing the keyboard and either the keyboard size or window is nil: panic widely.&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// resize view on hide keyboard</span>
    <span class="kd">func</span> <span class="nf">keyboardWillHideForResizing</span><span class="p">(</span><span class="n">notification</span><span class="p">:</span> <span class="n">Notification</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">keyboardSize</span> <span class="p">=</span> <span class="p">(</span><span class="n">notification</span><span class="p">.</span><span class="n">userInfo</span><span class="p">?[</span><span class="n">UIKeyboardFrameEndUserInfoKey</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="bp">NSValue</span><span class="p">)?.</span><span class="n">cgRectValue</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">viewHeight</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">height</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span> <span class="p">=</span> <span class="bp">CGRect</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
                                     <span class="n">y</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
                                     <span class="n">width</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
                                     <span class="n">height</span><span class="p">:</span> <span class="n">viewHeight</span> <span class="o">+</span> <span class="n">keyboardSize</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;We&#39;re about to hide the keyboard and the keyboard size is nil. Now is the rapture.&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

Теперь при вызове функции <code>setupViewResizerOnKeyboardShown()</code> мы автоматически подпишемся на уведомления о показе/скрытии клавиатуры и будем вызывать соответствующие методы увеличения/уменьшения корневого view.</p>
<p>Добавим последний extension для автоматического скрытия клавиатуы при тапе вне области клавиатуры:
<div class="codehilite"><pre><span></span><span class="c1">// hide keyboard on tap out of the keyboard</span>
<span class="kd">extension</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">hideKeyboardWhenTappedAround</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">tap</span><span class="p">:</span> <span class="bp">UITapGestureRecognizer</span> <span class="p">=</span> <span class="bp">UITapGestureRecognizer</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="kc">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="p">#</span><span class="n">selector</span><span class="p">(</span><span class="bp">UIViewController</span><span class="p">.</span><span class="n">dismissKeyboard</span><span class="p">))</span>
        <span class="n">tap</span><span class="p">.</span><span class="n">cancelsTouchesInView</span> <span class="p">=</span> <span class="kc">false</span>
        <span class="n">view</span><span class="p">.</span><span class="n">addGestureRecognizer</span><span class="p">(</span><span class="n">tap</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">dismissKeyboard</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">view</span><span class="p">.</span><span class="n">endEditing</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

В каждом из ViewController'ов с возможностью осуществления ввода с клавиатуры добавим вызов описанных функций приложения в методе <code>viewDidLoad()</code>:</p>
<div class="codehilite"><pre><span></span><span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="c1">// keyboard show-hide, resize window.</span>
        <span class="n">setupViewResizerOnKeyboardShown</span><span class="p">()</span>
        <span class="n">hideKeyboardWhenTappedAround</span><span class="p">()</span>
    <span class="p">}</span>
</pre></div>


<h3 id="scorocodesdk">Инициализация ScorocodeSDK</h3>
<p>Добавим в метод <code>application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?)</code> класса <code>AppDelegate</code> инициализацию ScorocodeSDK:
<div class="codehilite"><pre><span></span><span class="c1">//scorocode init</span>
        <span class="kd">let</span> <span class="nv">applicationId</span> <span class="p">=</span> <span class="s">&quot;cd02126a02e44643ba38c923cf699bb7&quot;</span>
        <span class="kd">let</span> <span class="nv">clientId</span> <span class="p">=</span> <span class="s">&quot;900ca6a05f604eb8a88aac6941efcaa4&quot;</span>
        <span class="kd">let</span> <span class="nv">accessKey</span> <span class="p">=</span> <span class="s">&quot;32e4b1c15e7d470dbbacab57fa6e8406&quot;</span>
        <span class="kd">let</span> <span class="nv">fileKey</span> <span class="p">=</span> <span class="s">&quot;98bd371cdca944bcbebd45eb13fa17b6&quot;</span>
        <span class="kd">let</span> <span class="nv">messageKey</span> <span class="p">=</span> <span class="s">&quot;171f8ac1fa6f4ed8b3ec623739b2ad04&quot;</span>
        <span class="n">SC</span><span class="p">.</span><span class="n">initWith</span><span class="p">(</span><span class="n">applicationId</span><span class="p">:</span> <span class="n">applicationId</span><span class="p">,</span> <span class="n">clientId</span><span class="p">:</span> <span class="n">clientId</span><span class="p">,</span> <span class="n">accessKey</span><span class="p">:</span> <span class="n">accessKey</span><span class="p">,</span> <span class="n">fileKey</span><span class="p">:</span> <span class="n">fileKey</span><span class="p">,</span> <span class="n">messageKey</span><span class="p">:</span> <span class="n">messageKey</span><span class="p">)</span>
</pre></div>

Посмотреть данные ключи можно на вкладке «Безопасность» настроек проекта.</p>
<h2 id="_4">Стартовый экран приложения.</h2>
<p>Создадим стартовый контроллер приложения с именем <code>LoginVC</code>. Для этого в Xcode выберем элемент <code>View Contoller</code> и перетащим его в storyboard. В приложении мы будем использовать 'UINavigationController' для навигации, поэтому выделим контроллер 'LoginVC' и выберем в Xcode <code>Editor → Embed in → Navigation Controller</code>. Накидаем на  стартовый контроллер поля для ввода логина, пароля, метки полей и две кнопки - для логина пользователя и регистрации пользователя. </p>
<p>Стартовый ViewController приложения, соответствующий классу <code>LoginVC</code>, показан на рисунке:</p>
<p><img alt="Стартовый ViewController приложения" src="../img/todolist/LoginVC.png" /></p>
<p>На данном экране пользователь БД может ввести свой логин и пароль и системе. Приложения проведет проверку правильности введенных данных при помощи метода <code>login()</code> класса <code>LoginVC</code>. Использование данного метода показано в листинге:</p>
<div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">login</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">scUser</span> <span class="p">=</span> <span class="n">SCUser</span><span class="p">()</span>
    <span class="n">scUser</span><span class="p">.</span><span class="n">login</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span> <span class="k">in</span>
        <span class="k">if</span> <span class="n">success</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">saveCredentials</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">parseUser</span><span class="p">(</span><span class="n">userDictionary</span><span class="p">:</span> <span class="n">result</span><span class="p">?[</span><span class="s">&quot;user&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">saveTokenToServer</span><span class="p">()</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Вход выполнен&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Добро пожаловать </span><span class="si">\(</span><span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="si">)</span><span class="s"> !&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">taskListVC</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">storyboard</span><span class="p">?.</span><span class="n">instantiateViewController</span><span class="p">(</span><span class="n">withIdentifier</span><span class="p">:</span> <span class="s">&quot;TaskListVC&quot;</span><span class="p">)</span> <span class="kc">as</span><span class="p">!</span> <span class="n">TaskListVC</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">navigationController</span><span class="p">?.</span><span class="n">show</span><span class="p">(</span><span class="n">taskListVC</span><span class="p">,</span> <span class="n">sender</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Вход не выполнен!&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;проверьте email и пароль.&quot;</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>В данном методе мы создаем новый экземпляр класса <code>SCUser</code> и вызываем его метод <code>login</code> при этом информацию о email и password пользователя мы берем из соответствующих <code>TextFiled</code>. Метод <code>login</code> проверит тот факт, что пользователь с таким email и паролем существует в коллекции «users».</p>
<p>В случае если в коллекции «users» имеется пользователь с указанными email и password, то будет выполнен блок кода:</p>
<p><div class="codehilite"><pre><span></span><span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">saveCredentials</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
<span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">parseUser</span><span class="p">(</span><span class="n">userDictionary</span><span class="p">:</span> <span class="n">result</span><span class="p">?[</span><span class="s">&quot;user&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])</span>
<span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">saveTokenToServer</span><span class="p">()</span>
<span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Вход выполнен&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Добро пожаловать </span><span class="si">\(</span><span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="si">)</span><span class="s"> !&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">taskListVC</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">storyboard</span><span class="p">?.</span><span class="n">instantiateViewController</span><span class="p">(</span><span class="n">withIdentifier</span><span class="p">:</span> <span class="s">&quot;TaskListVC&quot;</span><span class="p">)</span> <span class="kc">as</span><span class="p">!</span> <span class="n">TaskListVC</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">navigationController</span><span class="p">?.</span><span class="n">show</span><span class="p">(</span><span class="n">taskListVC</span><span class="p">,</span> <span class="n">sender</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

Опишем вызываемые методы подробнее.</p>
<p>Метод 
<div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">saveCredentials</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">email</span> <span class="p">=</span> <span class="n">email</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">password</span> <span class="p">=</span> <span class="n">password</span>
        <span class="n">UserDefaults</span><span class="p">.</span><span class="n">standard</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="s">&quot;email&quot;</span><span class="p">)</span>
        <span class="n">UserDefaults</span><span class="p">.</span><span class="n">standard</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="s">&quot;password&quot;</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>

сохранит введенные логин и пароль для последующего автоматического входа. Пользователю не потребуется вводить логин и пароль при каждом запуске приложения. Для смены пользователя можно будет произвести деавторизацию текущего пользователя на следующих экранах приложения,</p>
<p>Метод
<div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">parseUser</span><span class="p">(</span><span class="n">userDictionary</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span><span class="nb">Any</span><span class="p">]?)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="kd">let</span> <span class="nv">name</span> <span class="p">=</span> <span class="n">userDictionary</span><span class="p">?[</span><span class="s">&quot;username&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span>
        <span class="kd">let</span> <span class="nv">id</span> <span class="p">=</span> <span class="n">userDictionary</span><span class="p">?[</span><span class="s">&quot;_id&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span>
        <span class="kd">let</span> <span class="nv">email</span> <span class="p">=</span> <span class="n">userDictionary</span><span class="p">?[</span><span class="s">&quot;email&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span>
        <span class="kd">let</span> <span class="nv">roles</span> <span class="p">=</span> <span class="n">userDictionary</span><span class="p">?[</span><span class="s">&quot;roles&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">id</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">email</span> <span class="p">=</span> <span class="n">email</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">roleId</span> <span class="p">=</span> <span class="n">roles</span><span class="p">.</span><span class="bp">first</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nv">scQuery</span> <span class="p">=</span> <span class="n">SCQuery</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;roles&quot;</span><span class="p">)</span>
            <span class="n">scQuery</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">SCString</span><span class="p">(</span><span class="n">roleId</span><span class="p">))</span>
            <span class="n">scQuery</span><span class="p">.</span><span class="bp">find</span><span class="p">({</span> <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">in</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">role</span> <span class="p">=</span> <span class="p">(</span><span class="n">result</span><span class="p">?.</span><span class="n">values</span><span class="p">.</span><span class="bp">first</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])?[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span> <span class="n">role</span> <span class="p">==</span> <span class="s">&quot;boss&quot;</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">.</span><span class="n">isBoss</span> <span class="p">=</span> <span class="kc">true</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">isBoss</span> <span class="p">=</span> <span class="kc">false</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

парсит ответ от сервера при успешном логине пользователя и сохраняет в класс User. В ответе сервера (при успешном логине пользователя) содержатся все поля соотвествующей записи о пользователе в коллекции. Также здесь выполняется запрос имени роли пользователя - <code>manager</code> или <code>boss</code>. Для этого созадется новый объект <code>SCQuery</code>, объекту выставляется условие выборки и запускается поиск по запросу. 
Если запрос находит в списке ролей пользователя роль с именем <code>boss</code> - то пользователь получает возможность ставить задачи сотрудникам, удалять задачи, редактировать большую часть параметров задачи и видеть все задачи для всех пользователей.
Если запрос не находит в списке ролей пользователя роль с именем <code>boss</code> - то пользователь помечается как исполнитель задач. Исполнитель сможет видеть только свои задачи, писать комментарий исполнителя и менять статус задачи на "выполнено".</p>
<p>Метод
<div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">saveTokenToServer</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">scQuery</span> <span class="p">=</span> <span class="n">SCQuery</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;devices&quot;</span><span class="p">)</span>
    <span class="n">scQuery</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s">&quot;deviceId&quot;</span><span class="p">,</span> <span class="n">SCString</span><span class="p">(</span><span class="n">token</span><span class="p">))</span> <span class="c1">// one device - one user.</span>
    <span class="n">scQuery</span><span class="p">.</span><span class="n">remove</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span> <span class="k">in</span>
        <span class="k">if</span> <span class="n">success</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">scObject</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;devices&quot;</span><span class="p">)</span>
            <span class="n">scObject</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;userId&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="kc">self</span><span class="p">.</span><span class="n">id</span><span class="p">),</span>
                          <span class="s">&quot;deviceType&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;ios&quot;</span><span class="p">),</span>
                          <span class="s">&quot;deviceId&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="kc">self</span><span class="p">.</span><span class="n">token</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="n">scObject</span><span class="p">.</span><span class="n">save</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span> <span class="k">in</span>
                <span class="k">if</span> <span class="n">success</span> <span class="p">{</span>
                    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;token saved.&quot;</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;token didnt saved! Error: </span><span class="si">\(</span><span class="n">error</span><span class="p">.</span><span class="n">debugDescription</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Error while updating device token, Error: </span><span class="si">\(</span><span class="n">error</span><span class="p">!</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

Сохраняет токен устройства пользователя на сервер в системную коллекцию <code>devices</code>. Токен нужен для рассылки push-сообщений пользователям. При этом, на случай, если на одном устрйстве будут работать несколько пользователей, будем сперва удалять сохраненный токен с сервера, если токен уже был сохранен на сервере. Удаление объекта производится методом <code>remove()</code> класса <code>SCQuery</code>. Сохранение нового токена в коллекцию <code>devices</code> осуществляется с помощью методов:
<code>set()</code> -  установить поля документа.
<code>save()</code> - сохранить документ.</p>
<p>В зависимости от результата попытки регистрации пользователя, приложение показывает пользователю сообщение и просит перепроверить вводимые данные, или сообщает об успешной регистрации и переходит на следующий экран.</p>
<p>На стартовом экране так же имеется кнопка «Зарегистрироваться», позволяющая зарегистрировать нового пользователя в системе (добавить его в коллекцию «users» БД). Регистрация пользователя осуществляется на следующем экране, добавим обработчик нажатия на кнопку "Зарегистрироваться":</p>
<div class="codehilite"><pre><span></span><span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">buttonRegisterTapped</span><span class="p">(</span><span class="kc">_</span> <span class="n">sender</span><span class="p">:</span> <span class="nb">Any</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">registerVC</span> <span class="p">=</span> <span class="n">storyboard</span><span class="p">?.</span><span class="n">instantiateViewController</span><span class="p">(</span><span class="n">withIdentifier</span><span class="p">:</span> <span class="s">&quot;RegisterVC&quot;</span><span class="p">)</span> <span class="kc">as</span><span class="p">!</span> <span class="n">RegisterVC</span>
    <span class="n">navigationController</span><span class="p">?.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">registerVC</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h2 id="_5">Экран регистрации нового пользователя</h2>
<p>Создадим новый ViewController с именем <code>RegisterVC</code> и добавим элементы TextField для ввода email, имени, пароля и подтверждения пароля пользователя. А также добавим кнопку "Зарегистрироваться". Данный экран показан на рисунке:</p>
<p><img alt="Экран регистрации нового пользователя" src="../img/todolist/RegisterVC.png" /></p>
<p>На данном экране вводятся все необходимые поля документа (характеризующие пользователя). Добавим обработчик нажатия для кнопки «Зарегистрировать» вызывающий метод <code>signup</code> класса <code>RegisterVC</code> для регистрации нового пользователя:
<div class="codehilite"><pre><span></span><span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">buttonRegisterTapped</span><span class="p">(</span><span class="kc">_</span> <span class="n">sender</span><span class="p">:</span> <span class="nb">AnyObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">guard</span> <span class="n">textFieldPassword</span><span class="p">.</span><span class="n">text</span> <span class="p">==</span> <span class="n">textFieldConfirmPassword</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="n">textFieldConfirmPassword</span><span class="p">.</span><span class="n">text</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Пароли должны совпадать&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Пароль и подтверждение пароля не совпадают!&quot;</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="n">guard</span> <span class="kd">let</span> <span class="nv">email</span> <span class="p">=</span> <span class="n">textFieldEmail</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="n">email</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">password</span> <span class="p">=</span> <span class="n">textFieldPassword</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="n">password</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Регистрация не выполнена!&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Email и пароль доолжны быть заполнены.&quot;</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="n">signup</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="n">textFieldEmail</span><span class="p">.</span><span class="n">text</span><span class="p">!,</span> <span class="n">password</span><span class="p">:</span> <span class="n">textFieldPassword</span><span class="p">.</span><span class="n">text</span><span class="p">!,</span> <span class="n">name</span><span class="p">:</span> <span class="n">textFieldName</span><span class="p">.</span><span class="n">text</span> <span class="p">??</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

Обработчик проверяет корректность введенных данных и вызывает метод регистраиции пользователя:</p>
<p><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">signup</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">scUser</span> <span class="p">=</span> <span class="n">SCUser</span><span class="p">()</span>
    <span class="n">scUser</span><span class="p">.</span><span class="n">signup</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="n">success</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">saveCredentials</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">saveTokenToServer</span><span class="p">()</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">parseUser</span><span class="p">(</span><span class="n">userDictionary</span><span class="p">:</span> <span class="n">result</span><span class="p">?[</span><span class="s">&quot;user&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Успешно&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Вы успешно зарегистрировались&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">taskListVC</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">storyboard</span><span class="p">?.</span><span class="n">instantiateViewController</span><span class="p">(</span><span class="n">withIdentifier</span><span class="p">:</span> <span class="s">&quot;TaskListVC&quot;</span><span class="p">)</span> <span class="kc">as</span><span class="p">!</span> <span class="n">TaskListVC</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">navigationController</span><span class="p">?.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">taskListVC</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Регистрация не выполнена!&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Попробуйте еще раз.&quot;</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

Если регистрация прошла успешно - сервер автоматически авторизует нового пользователя и присылает в ответе поля документа пользователя. Поэтому здесь мы можем вызвать те же методы, что и при авторизации пользоваеля. Методы были уже описаны выше.</p>
<p>В случае если регистрация пользователя прошла успешно (т.е если sdk инициализирован, все ключи указаны правильно и нет конфликта с уже существующими пользователями), будет выполнен переход к экрану списка задач.</p>
<h2 id="_6">Экран списка задач.</h2>
<p>Создадим экран списка задач приложения с именем <code>TaskListVC</code> и добавим на него элемент UITableView вместе с элементом UITableViewCell. На данном экране пользователь с ролью <code>maanger</code> будет видеть только свои задачи, а пользователь с ролью <code>boss</code> будет видеть все задачи. Кнопка "Создать" будет доступна только пользователю с ролью <code>boss</code>. На элемент UITableViewCell перетащим элементы для отображения информации о задаче - имя задачи, статусы задачи, ответственный и срок выполнения. Также добавим две кнопки - "Выйти" (для деаутентификации пользователя) и "Создать" (для создания новой задачи). Вид экрана список задач показана на картинке: </p>
<p><img alt="Экран списка задач" src="../img/todolist/TaskListVC.png" /></p>
<p>Экран представляет собой <code>TableView</code> в который мы передаем информацию о задачах, хранящихся в БД. 
Добавим класс <code>TaskListCell</code>, который будет реализовывать внешний вид ячейки таблицы:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">TaskListCell</span> <span class="p">:</span> <span class="bp">UITableViewCell</span> <span class="p">{</span>

    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">labelTaskName</span><span class="p">:</span> <span class="bp">UILabel</span><span class="p">!</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">imageViewStatusDone</span><span class="p">:</span> <span class="bp">UIImageView</span><span class="p">!</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">imageViewStatusClosed</span><span class="p">:</span> <span class="bp">UIImageView</span><span class="p">!</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">labelCloseDate</span><span class="p">:</span> <span class="bp">UILabel</span><span class="p">!</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">labelUsername</span><span class="p">:</span> <span class="bp">UILabel</span><span class="p">!</span>

    <span class="kd">func</span> <span class="nf">setupCell</span><span class="p">(</span><span class="kc">_</span> <span class="n">taskName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">statusDone</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">,</span> <span class="n">statusClosed</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">,</span> <span class="n">closeDate</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">labelTaskName</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">taskName</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">imageViewStatusDone</span><span class="p">.</span><span class="n">image</span> <span class="p">=</span> <span class="n">statusDone</span> <span class="p">?</span> <span class="bp">UIImage</span><span class="p">(</span><span class="n">named</span><span class="p">:</span> <span class="s">&quot;StatusOk&quot;</span><span class="p">)</span> <span class="p">:</span> <span class="bp">UIImage</span><span class="p">(</span><span class="n">named</span><span class="p">:</span> <span class="s">&quot;StatusBad&quot;</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">imageViewStatusClosed</span><span class="p">.</span><span class="n">image</span> <span class="p">=</span> <span class="n">statusClosed</span> <span class="p">?</span> <span class="bp">UIImage</span><span class="p">(</span><span class="n">named</span><span class="p">:</span> <span class="s">&quot;StatusOk&quot;</span><span class="p">)</span> <span class="p">:</span> <span class="bp">UIImage</span><span class="p">(</span><span class="n">named</span><span class="p">:</span> <span class="s">&quot;StatusBad&quot;</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">labelUsername</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">username</span>
        <span class="kd">let</span> <span class="nv">dateFormatter</span> <span class="p">=</span> <span class="n">DateFormatter</span><span class="p">()</span>
        <span class="n">dateFormatter</span><span class="p">.</span><span class="n">dateFormat</span> <span class="p">=</span> <span class="s">&quot;dd-MM-yyyy HH:mm&quot;</span>
        <span class="n">dateFormatter</span><span class="p">.</span><span class="n">timeZone</span> <span class="p">=</span> <span class="n">TimeZone</span><span class="p">.</span><span class="n">autoupdatingCurrent</span>
        <span class="kd">let</span> <span class="nv">dateObj</span> <span class="p">=</span> <span class="n">dateFormatter</span><span class="p">.</span><span class="n">string</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">closeDate</span><span class="p">)</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">labelCloseDate</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">dateObj</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">contentView</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">statusClosed</span> <span class="p">?</span> <span class="mf">0.3</span> <span class="p">:</span> <span class="mf">1.0</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>В класс ячейки таблицы выведены аутлеты из сториборда приложения, представляющие собой элементы в ячейке таблицы, а так же создан метод <code>setupCell</code> для настройки внешнего вида таблицы.</p>
<p>Добавим в код контроллера экрана код для работы таблицы. Для удобства пользователей будем подкрашивать четные и нечетные ячейки разным цветом:</p>
<div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">numberOfRowsInSection</span> <span class="n">section</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">taskList</span><span class="p">.</span><span class="bp">count</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">heightForFooterInSection</span> <span class="n">section</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">CGFloat</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mf">0.01</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">heightForHeaderInSection</span> <span class="n">section</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">CGFloat</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mf">0.01</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">cellForRowAt</span> <span class="n">indexPath</span><span class="p">:</span> <span class="n">IndexPath</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="bp">UITableViewCell</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">cell</span> <span class="p">=</span> <span class="n">tableView</span><span class="p">.</span><span class="n">dequeueReusableCell</span><span class="p">(</span><span class="n">withIdentifier</span><span class="p">:</span> <span class="s">&quot;cell&quot;</span><span class="p">)</span> <span class="kc">as</span><span class="p">!</span> <span class="n">TaskListCell</span>
        <span class="kd">let</span> <span class="nv">task</span> <span class="p">=</span> <span class="n">taskList</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">]</span>
        <span class="n">cell</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="p">=</span> <span class="p">(</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">?</span> <span class="bp">UIColor</span><span class="p">(</span><span class="n">hex</span><span class="p">:</span> <span class="mh">0xEFEFEF</span><span class="p">)</span> <span class="p">:</span> <span class="bp">UIColor</span><span class="p">(</span><span class="n">hex</span><span class="p">:</span> <span class="mh">0xFEFEFE</span><span class="p">)</span>
        <span class="n">cell</span><span class="p">.</span><span class="n">setupCell</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">statusDone</span><span class="p">:</span> <span class="n">task</span><span class="p">.</span><span class="n">isDone</span><span class="p">,</span> <span class="n">statusClosed</span><span class="p">:</span> <span class="n">task</span><span class="p">.</span><span class="n">isClose</span><span class="p">,</span> <span class="n">closeDate</span><span class="p">:</span> <span class="n">task</span><span class="p">.</span><span class="n">closeDate</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">task</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cell</span>
    <span class="p">}</span>
</pre></div>


<p>Для отображения информации создадим метод с именем <code>getTasks</code> код которого показан ниже:</p>
<div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">getTasks</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">view</span><span class="p">.</span><span class="n">isUserInteractionEnabled</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="n">activityIndicator</span><span class="p">.</span><span class="n">startAnimating</span><span class="p">()</span>
    <span class="n">taskList</span><span class="p">.</span><span class="bp">removeAll</span><span class="p">()</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nv">scQuery</span> <span class="p">=</span> <span class="n">SCQuery</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;tasks&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">user</span><span class="p">.</span><span class="n">isBoss</span> <span class="p">{</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="n">SCString</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="n">scQuery</span><span class="p">.</span><span class="bp">find</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span> <span class="k">in</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">isUserInteractionEnabled</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">activityIndicator</span><span class="p">.</span><span class="n">stopAnimating</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">?.</span><span class="bp">count</span><span class="p">)</span><span class="o">!</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">e</span> <span class="k">in</span> <span class="p">(</span><span class="n">result</span><span class="p">?.</span><span class="n">values</span><span class="p">)</span><span class="o">!</span> <span class="p">{</span>
                <span class="n">guard</span> <span class="kd">let</span> <span class="nv">elem</span> <span class="p">=</span> <span class="n">e</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span><span class="nb">Any</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">break</span>
                <span class="p">}</span>
                <span class="kd">let</span> <span class="nv">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">()</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">id</span> <span class="p">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&quot;_id&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">id</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">name</span> <span class="p">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">isClose</span> <span class="p">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&quot;Closed&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">Bool</span> <span class="p">{</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">isClose</span> <span class="p">=</span> <span class="n">isClose</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">isDone</span> <span class="p">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&quot;Done&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">Bool</span> <span class="p">{</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">isDone</span> <span class="p">=</span> <span class="n">isDone</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">closeDate</span> <span class="p">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&quot;closeDate&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="n">Date</span> <span class="p">{</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">closeDate</span> <span class="p">=</span> <span class="n">closeDate</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">comment</span> <span class="p">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&quot;comment&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">comment</span> <span class="p">=</span> <span class="n">comment</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">bossComment</span> <span class="p">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&quot;bossComment&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">bossComment</span> <span class="p">=</span> <span class="n">bossComment</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">detailed</span> <span class="p">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&quot;detailed&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">detailed</span> <span class="p">=</span> <span class="n">detailed</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">user</span> <span class="p">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&quot;user&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">user</span> <span class="p">=</span> <span class="n">user</span>
                <span class="p">}</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">getUserNameAndAddTask</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">success</span> <span class="p">{</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Список задач пока пуст.&quot;</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">isUserInteractionEnabled</span> <span class="p">=</span> <span class="kc">true</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">activityIndicator</span><span class="p">.</span><span class="n">stopAnimating</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Метод <code>getTasks</code> производит поиск документов в коллекции <code>tasks</code> с помощью метода <code>find()</code> класса <code>SCQuery</code>. При этом, если пользователь не обладает ролью <code>boss</code>, то в запрос устанавливается условие для поиска документов только для текущего пользователя:</p>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="o">!</span><span class="n">user</span><span class="p">.</span><span class="n">isBoss</span> <span class="p">{</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="n">SCString</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
    <span class="p">}</span>
</pre></div>


<p>Далее метод <code>getTasks</code> парсит ответ сервера с документами, разбирая поля документа. После чего происходит вызов метода:
<div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">getUserNameAndAddTask</span><span class="p">(</span><span class="kc">_</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">view</span><span class="p">.</span><span class="n">isUserInteractionEnabled</span> <span class="p">=</span> <span class="kc">false</span>
        <span class="n">activityIndicator</span><span class="p">.</span><span class="n">startAnimating</span><span class="p">()</span>
        <span class="kd">var</span> <span class="nv">scQuery</span> <span class="p">=</span> <span class="n">SCQuery</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;users&quot;</span><span class="p">)</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="n">fields</span><span class="p">([</span><span class="s">&quot;username&quot;</span><span class="p">])</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">SCString</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">user</span><span class="p">))</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="bp">find</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span>  <span class="k">in</span>
            <span class="k">if</span> <span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">?.</span><span class="bp">count</span><span class="p">)</span><span class="o">!</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">username</span> <span class="p">=</span> <span class="p">(</span><span class="n">result</span><span class="p">?.</span><span class="n">values</span><span class="p">.</span><span class="bp">first</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])?[</span><span class="s">&quot;username&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">username</span> <span class="p">=</span> <span class="n">username</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Ошибка!&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Не найдено имя пользователя для задачи </span><span class="si">\(</span><span class="n">task</span><span class="p">.</span><span class="n">name</span><span class="si">)</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">taskList</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="c1">//sort by fields: isClosed, closeDate</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">taskList</span><span class="p">.</span><span class="bp">sort</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="p">{</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="k">in</span>
                <span class="k">if</span> <span class="n">t1</span><span class="p">.</span><span class="n">isClose</span> <span class="p">==</span> <span class="n">t2</span><span class="p">.</span><span class="n">isClose</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="n">t1</span><span class="p">.</span><span class="n">closeDate</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="n">t2</span><span class="p">.</span><span class="n">closeDate</span><span class="p">)</span> <span class="p">==</span> <span class="n">ComparisonResult</span><span class="p">.</span><span class="n">orderedAscending</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="o">!</span><span class="n">t1</span><span class="p">.</span><span class="n">isClose</span> <span class="o">&amp;&amp;</span> <span class="n">t2</span><span class="p">.</span><span class="n">isClose</span> <span class="p">})</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">isUserInteractionEnabled</span> <span class="p">=</span> <span class="kc">true</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">activityIndicator</span><span class="p">.</span><span class="n">stopAnimating</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

Данный метод производит запрос поля "username" из коллекции "users" , чтобы сохранить в задачу имя пользователя. Меод парсит ответ от сервера, после чего сохраняет задачу в список <code>taskList</code>. Так как запросы выполняется асинхронно, то после каждого добавления задачи в список мы заново сортируем список. Сначала по дате выполнения, а потом по статусу - "закрыта" или "не закрыта". Закрытые задачи показываются всегда в конце списка, для более удобной навигации.</p>
<p>Добавим в код данного экрана обработчик кнопки "Выход":</p>
<p><div class="codehilite"><pre><span></span><span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">buttonLogoutPressed</span><span class="p">(</span><span class="kc">_</span> <span class="n">sender</span><span class="p">:</span> <span class="nb">AnyObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">alert</span> <span class="p">=</span> <span class="bp">UIAlertController</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Выйти из системы?&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">preferredStyle</span><span class="p">:</span> <span class="p">.</span><span class="n">alert</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nv">logout</span> <span class="p">=</span> <span class="bp">UIAlertAction</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Выйти&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="n">destructive</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">action</span> <span class="k">in</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">navigationController</span><span class="p">?.</span><span class="n">popToRootViewController</span><span class="p">(</span><span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">alert</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">logout</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nv">cancel</span> <span class="p">=</span> <span class="bp">UIAlertAction</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Отмена&quot;</span><span class="p">,</span> <span class="n">style</span><span class="p">:</span> <span class="p">.</span><span class="n">cancel</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="n">alert</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">cancel</span><span class="p">)</span>
    <span class="n">present</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

При деаутентификации пользователя мы должны очистить данные пользователя, сохраненные локально. Для этого вызывается метод <code>clear</code> у класса <code>User</code>:</p>
<p><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">clear</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">id</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">password</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">name</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">isBoss</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="n">token</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>

    <span class="n">UserDefaults</span><span class="p">.</span><span class="n">standard</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="s">&quot;email&quot;</span><span class="p">)</span>
    <span class="n">UserDefaults</span><span class="p">.</span><span class="n">standard</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="s">&quot;password&quot;</span><span class="p">)</span>
    <span class="c1">//remove token from server:</span>
    <span class="n">removeTokenFromServer</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>

Метод очистки обнуляет поля пользователя и удаляет сохраненный токен push-сообщений с сервера, посредством вызова метода <code>removeTokenFromServer</code> у класса `User':</p>
<p><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">removeTokenFromServer</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">scQuery</span> <span class="p">=</span> <span class="n">SCQuery</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;devices&quot;</span><span class="p">)</span>
    <span class="n">scQuery</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s">&quot;deviceId&quot;</span><span class="p">,</span> <span class="n">SCString</span><span class="p">(</span><span class="kc">self</span><span class="p">.</span><span class="n">token</span><span class="p">))</span> <span class="c1">// one device - one user.</span>
    <span class="n">scQuery</span><span class="p">.</span><span class="n">remove</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span> <span class="k">in</span>
        <span class="k">if</span> <span class="n">success</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;token removed&quot;</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Error while updating device token, Error: </span><span class="si">\(</span><span class="n">error</span><span class="p">!</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>

Метод удаления токена с сервера делает запрос в коллекцию "devices", устанавливая условие выборки поиска документа по токену. Далее происходит удаление документа из коллекции.</p>
<p>Добавим в код экрана обработчик нажатия на кнопку "Создать":</p>
<div class="codehilite"><pre><span></span><span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">buttonCreateTouchUpInside</span><span class="p">(</span><span class="kc">_</span> <span class="n">sender</span><span class="p">:</span> <span class="nb">AnyObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">taskDetailVC</span> <span class="p">=</span> <span class="n">storyboard</span><span class="p">?.</span><span class="n">instantiateViewController</span><span class="p">(</span><span class="n">withIdentifier</span><span class="p">:</span> <span class="s">&quot;TaskDetailVC&quot;</span><span class="p">)</span> <span class="kc">as</span><span class="p">!</span> <span class="n">TaskDetailVC</span>
        <span class="n">taskDetailVC</span><span class="p">.</span><span class="n">isCreateMode</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="n">navigationController</span><span class="p">?.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">taskDetailVC</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>


<p>Обработчик осуществляет переход на экран показа деталей задачи, одновременно являющийся и экраном создания задачи. Для задания режима работы экрана деталей задачи устанавливается переменная <code>isCreateMode</code>. Так как мы нажимаем на кнопку создания новой задачи, то переменная <code>isCreateMode</code> устанавливается в зачение <code>true</code></p>
<p>Добавим в код контроллера экрана обработку клика по ячейке таблицы. При клике на ячеке таблицы пользователь переходит на экран показа деталей задачи. Для этого установим вышеописанную переменную <code>isCreateMode</code> в значение <code>false</code>. А также передадим данные задачи из ячейки:</p>
<div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="kc">_</span> <span class="n">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="n">indexPath</span><span class="p">:</span> <span class="n">IndexPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">taskDetailVC</span> <span class="p">=</span> <span class="n">storyboard</span><span class="p">?.</span><span class="n">instantiateViewController</span><span class="p">(</span><span class="n">withIdentifier</span><span class="p">:</span> <span class="s">&quot;TaskDetailVC&quot;</span><span class="p">)</span> <span class="kc">as</span><span class="p">!</span> <span class="n">TaskDetailVC</span>
        <span class="n">taskDetailVC</span><span class="p">.</span><span class="n">task</span> <span class="p">=</span> <span class="n">taskList</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">]</span>
        <span class="n">taskDetailVC</span><span class="p">.</span><span class="n">isCreateMode</span> <span class="p">=</span> <span class="kc">false</span>
        <span class="n">navigationController</span><span class="p">?.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">taskDetailVC</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>


<h2 id="_7">Экран с деталями задачи / создания новой задачи.</h2>
<p>Создадим UIViewController с именем <code>TaskDetailVC</code> и добавим его на storyboard приложения. Набросаем элементы, отображающие параметры задачи - поле для выбора ответственного пользователя, срок выполнения задачи, название задачи, подробное описание задачи, задача выполнена, задача закрыта, комментарий исполнителя, комментарий постановщика, история задачи и кнопка "удалить задачу". Вид экрана показан на рисунке:</p>
<p><img alt="Экран редактирования/создания новой задачи в БД" src="../img/todolist/TaskDetailVC.png" /></p>
<p>На этом экране пользователь вводит всю необходиму информацию о задаче и нажимает кнопку "Сохранить". При этом программа создает новый документ, заполняет его поля и сохраняет на сервере. Режим работы экрана зависит от переменной <code>isCreateMode</code> - true для режима создания новой задачи и false для редактирования существующей задачи. Для назначения ответственных нам понадобятся имена и идентификаторы пользователей. Имена мы будем показывать на экране, а связывать задачу с учетной записью пользователя - по идентификаторам. Добавим код в метод <code>viewDidLoad</code> загрузки имен и идентификаторов пользователей:</p>
<p><div class="codehilite"><pre><span></span><span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="n">setupViewResizerOnKeyboardShown</span><span class="p">()</span>
        <span class="n">hideKeyboardWhenTappedAround</span><span class="p">()</span>
        <span class="n">getUserListForUserPicker</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">isCreateMode</span> <span class="p">==</span> <span class="kc">false</span><span class="p">{</span>
            <span class="n">getHistory</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

Метод <code>getUserListForUserPicker</code> имеет вид:
<div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">getUserListForUserPicker</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">userList</span><span class="p">.</span><span class="bp">removeAll</span><span class="p">()</span>
    <span class="c1">// if we look details of task and we are not a boss</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isCreateMode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="p">.</span><span class="n">isBoss</span><span class="p">)</span> <span class="o">||</span> <span class="n">task</span><span class="p">.</span><span class="n">isClose</span> <span class="p">{</span>
        <span class="n">userList</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">IdAndName</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">task</span><span class="p">.</span><span class="n">user</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">task</span><span class="p">.</span><span class="n">username</span><span class="p">))</span>
        <span class="n">pickerViewUsers</span><span class="p">.</span><span class="n">reloadAllComponents</span><span class="p">()</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// if we create new task or boss opens task:</span>
        <span class="kd">var</span> <span class="nv">scQuery</span> <span class="p">=</span> <span class="n">SCQuery</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;users&quot;</span><span class="p">)</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="n">fields</span><span class="p">([</span><span class="s">&quot;_id&quot;</span><span class="p">,</span><span class="s">&quot;username&quot;</span><span class="p">])</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="n">notEqualTo</span><span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">SCString</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="bp">find</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span> <span class="k">in</span>
            <span class="k">if</span> <span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">?.</span><span class="bp">count</span><span class="p">)</span><span class="o">!</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="k">in</span> <span class="p">(</span><span class="n">result</span><span class="p">!.</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="kd">let</span> <span class="nv">id</span> <span class="p">=</span> <span class="p">(</span><span class="n">elem</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])?[</span><span class="s">&quot;_id&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span>
                        <span class="kd">let</span> <span class="nv">name</span> <span class="p">=</span> <span class="p">(</span><span class="n">elem</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])?[</span><span class="s">&quot;username&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                        <span class="kc">self</span><span class="p">.</span><span class="n">userList</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">IdAndName</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">name</span><span class="p">))</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Ошибка!&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Не удалось получить список исполнителей&quot;</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">userList</span><span class="p">.</span><span class="bp">sort</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span><span class="p">.</span><span class="n">name</span> <span class="o">&lt;</span> <span class="nv">$1</span><span class="p">.</span><span class="n">name</span><span class="p">})</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">pickerViewUsers</span><span class="p">.</span><span class="n">reloadAllComponents</span><span class="p">()</span>
            <span class="c1">//select current user</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span> <span class="k">in</span> <span class="kc">self</span><span class="p">.</span><span class="n">userList</span><span class="p">.</span><span class="n">enumerated</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="n">id</span> <span class="p">==</span> <span class="kc">self</span><span class="p">.</span><span class="n">task</span><span class="p">.</span><span class="n">user</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">.</span><span class="n">pickerViewUsers</span><span class="p">.</span><span class="n">selectRow</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">inComponent</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

При запуске метод проверяет режим работы экрана и роль пользователя. Если задача закрыта, или задачу смотрит исполнитель - мы не будем делать запрос списка имен и идентификаторов пользователей, а покажем уже имеющийся id и имя исполнителя. В других случаях,  мы делаем запрос к коллекции <code>users</code> и сохраняем всех пользователей, кроме текущего.  Дальше происходит парсинг ответа сервера и сохранение пары "идентификатор, имя пользователя" в список <code>userList</code>. далее мы сортируем список <code>pickerViewUsers</code> и переходим на текущего пользователя у элемента <code>pickerViewUsers</code>. </p>
<p>Метод <code>viewDidLoad</code> также вызывает метод для загузки истории задачи, если экран находится в режиме редактирования:</p>
<p><div class="codehilite"><pre><span></span> <span class="kd">func</span> <span class="nf">getHistory</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">historyList</span><span class="p">.</span><span class="bp">removeAll</span><span class="p">()</span>
        <span class="kd">var</span> <span class="nv">scQuery</span> <span class="p">=</span> <span class="n">SCQuery</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="n">fields</span><span class="p">([</span><span class="s">&quot;createdAt&quot;</span><span class="p">,</span><span class="s">&quot;value&quot;</span><span class="p">,</span><span class="s">&quot;field&quot;</span><span class="p">])</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s">&quot;task&quot;</span><span class="p">,</span> <span class="n">SCString</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
        <span class="n">scQuery</span><span class="p">.</span><span class="bp">find</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span> <span class="k">in</span>
            <span class="k">if</span> <span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">?.</span><span class="bp">count</span><span class="p">)</span><span class="o">!</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="k">in</span> <span class="p">(</span><span class="n">result</span><span class="p">?.</span><span class="n">values</span><span class="p">)</span><span class="o">!</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="kd">let</span> <span class="nv">date</span> <span class="p">=</span> <span class="p">(</span><span class="n">elem</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])?[</span><span class="s">&quot;createdAt&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="n">Date</span><span class="p">,</span>
                        <span class="kd">let</span> <span class="nv">value</span> <span class="p">=</span> <span class="p">(</span><span class="n">elem</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])?[</span><span class="s">&quot;value&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span>
                        <span class="kd">let</span> <span class="nv">field</span> <span class="p">=</span> <span class="p">(</span><span class="n">elem</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])?[</span><span class="s">&quot;field&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                        <span class="kc">self</span><span class="p">.</span><span class="n">historyList</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">History</span><span class="p">(</span><span class="n">date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">field</span><span class="p">))</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Ошибка!&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Не удалось загрузить историю задачи&quot;</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">historyList</span><span class="p">.</span><span class="bp">sort</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="p">{</span><span class="nv">$0</span><span class="p">.</span><span class="n">date</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="nv">$1</span><span class="p">.</span><span class="n">date</span><span class="p">)</span> <span class="p">==</span> <span class="n">ComparisonResult</span><span class="p">.</span><span class="n">orderedAscending</span><span class="p">})</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">tableViewHistory</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

Данный метод делает выборку из коллекции <code>history</code> с возвратом полей createdAt (время действия), value (новое значение), field (имя поля, которое было изменено). После выборки, парсится ответ от сервера и документ истории сохраняется в список <code>historyList</code></p>
<p>Рассмотрим самый большой метод экрана <code>saveHistory</code>, который реализует сохранение истории изменений:</p>
<p><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">saveHistory</span><span class="p">(</span><span class="kc">_</span> <span class="n">newTask</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">items</span> <span class="p">=</span> <span class="p">[</span><span class="n">SCObject</span><span class="p">]()</span>
        <span class="kd">var</span> <span class="nv">mode</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
        <span class="cm">/* mode values:</span>
<span class="cm">         var UserHasDoneTask</span>
<span class="cm">         var BossHasCloseTask</span>
<span class="cm">         var BossHasntDone</span>
<span class="cm">        */</span>
        <span class="k">if</span> <span class="n">isCreateMode</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">scObject</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
            <span class="n">scObject</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">id</span><span class="p">),</span>
                <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Задача:&quot;</span><span class="p">),</span>
                <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Создана.&quot;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="n">items</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">scObject</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">newTask</span><span class="p">.</span><span class="n">name</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
                <span class="n">item</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Название задачи изменено:&quot;</span><span class="p">),</span> <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">name</span><span class="p">)])</span>
                <span class="n">items</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">.</span><span class="n">comment</span> <span class="o">!=</span> <span class="n">newTask</span><span class="p">.</span><span class="n">comment</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
                <span class="n">item</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Исполнитель изменил комментарий:&quot;</span><span class="p">),</span> <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">comment</span><span class="p">)])</span>
                <span class="n">items</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">.</span><span class="n">bossComment</span> <span class="o">!=</span> <span class="n">newTask</span><span class="p">.</span><span class="n">bossComment</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
                <span class="n">item</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Босс изменил комментарий:&quot;</span><span class="p">),</span> <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">bossComment</span><span class="p">)])</span>
                <span class="n">items</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">.</span><span class="n">detailed</span> <span class="o">!=</span> <span class="n">newTask</span><span class="p">.</span><span class="n">detailed</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
                <span class="n">item</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Описание изменено:&quot;</span><span class="p">),</span> <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">detailed</span><span class="p">)])</span>
                <span class="n">items</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">.</span><span class="n">closeDate</span> <span class="o">!=</span> <span class="n">newTask</span><span class="p">.</span><span class="n">closeDate</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">dateFormatter</span> <span class="p">=</span> <span class="n">DateFormatter</span><span class="p">()</span>
                <span class="n">dateFormatter</span><span class="p">.</span><span class="n">timeZone</span> <span class="p">=</span> <span class="n">TimeZone</span><span class="p">.</span><span class="n">autoupdatingCurrent</span>
                <span class="n">dateFormatter</span><span class="p">.</span><span class="n">dateFormat</span> <span class="p">=</span> <span class="s">&quot;dd-MM-yyyy HH:mm&quot;</span>
                <span class="kd">let</span> <span class="nv">value</span> <span class="p">=</span> <span class="n">dateFormatter</span><span class="p">.</span><span class="n">string</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">newTask</span><span class="p">.</span><span class="n">closeDate</span><span class="p">)</span>
                <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
                <span class="n">item</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Изменен срок:&quot;</span><span class="p">),</span> <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">value</span><span class="p">)])</span>
                <span class="n">items</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">.</span><span class="n">username</span> <span class="o">!=</span> <span class="n">newTask</span><span class="p">.</span><span class="n">username</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
                <span class="n">item</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Исполнитель изменен:&quot;</span><span class="p">),</span> <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">username</span><span class="p">)])</span>
                <span class="n">items</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">.</span><span class="n">isDone</span> <span class="o">!=</span> <span class="n">newTask</span><span class="p">.</span><span class="n">isDone</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
                <span class="kd">let</span> <span class="nv">statusString</span> <span class="p">=</span> <span class="n">newTask</span><span class="p">.</span><span class="n">isDone</span> <span class="p">?</span> <span class="s">&quot;Выполнена.&quot;</span> <span class="p">:</span> <span class="s">&quot;Не выполнена.&quot;</span>
                <span class="n">item</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Задача:&quot;</span><span class="p">),</span> <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">statusString</span><span class="p">)])</span>
                <span class="n">items</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newTask</span><span class="p">.</span><span class="n">isDone</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="p">.</span><span class="n">isBoss</span> <span class="p">{</span>
                    <span class="n">mode</span> <span class="p">=</span> <span class="s">&quot;UserHasDoneTask&quot;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="n">newTask</span><span class="p">.</span><span class="n">isDone</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="p">.</span><span class="n">isBoss</span> <span class="p">{</span>
                    <span class="n">mode</span> <span class="p">=</span> <span class="s">&quot;BossHasntDone&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">.</span><span class="n">isClose</span> <span class="o">!=</span> <span class="n">newTask</span><span class="p">.</span><span class="n">isClose</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">item</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
                <span class="n">item</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;task&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="s">&quot;field&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Задача:&quot;</span><span class="p">),</span> <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;Закрыта.&quot;</span><span class="p">)])</span>
                <span class="n">items</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newTask</span><span class="p">.</span><span class="n">isClose</span> <span class="p">{</span>
                    <span class="n">mode</span> <span class="p">=</span> <span class="s">&quot;BossHasCloseTask&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">alertUser</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n">mode</span><span class="p">,</span> <span class="n">userId</span><span class="p">:</span> <span class="n">newTask</span><span class="p">.</span><span class="n">user</span><span class="p">,</span> <span class="n">userName</span><span class="p">:</span> <span class="n">newTask</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">taskName</span><span class="p">:</span> <span class="n">newTask</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">//try to save</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="n">items</span><span class="p">.</span><span class="bp">count</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">scObject</span> <span class="p">=</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">activityIndicator</span><span class="p">.</span><span class="n">startAnimating</span><span class="p">()</span>
            <span class="n">contentView</span><span class="p">.</span><span class="n">isUserInteractionEnabled</span> <span class="p">=</span> <span class="kc">false</span>
            <span class="n">scObject</span><span class="p">.</span><span class="n">save</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span> <span class="k">in</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">activityIndicator</span><span class="p">.</span><span class="n">stopAnimating</span><span class="p">()</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">contentView</span><span class="p">.</span><span class="n">isUserInteractionEnabled</span> <span class="p">=</span> <span class="kc">true</span>
                <span class="k">if</span> <span class="o">!</span><span class="n">success</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Ошибка!&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Не удалось сохранить элемент истории&quot;</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">i</span> <span class="p">==</span> <span class="n">items</span><span class="p">.</span><span class="bp">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">.</span><span class="n">navigationController</span><span class="p">?.</span><span class="n">popViewController</span><span class="p">(</span><span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

В метод передается параметр <code>newTask</code>,  представляющий собой новые параметры задачи. Если экран работает в режиме создания новой задачи - все просто, записываем на сервер один документ с записью о созднии задачи. Если экран работает в режиме редактирования, то мы должны сравнить исходное состояние задачи с измененнным ссстяонимем задачи. Для этого мы поочередно сравниваем переменные двух задач, и при несовпадении - добавляем запись об изменении в список изменений <code>items</code>.
После формирования списка документов запускается цикл сохранения документов на сервер. Так как запросы на сохранение документов на сервер выполняются асинхронно, после сохранения последнего документа из списка мы возвращаемся на экран списка задач.
Так же в данном методе проверяется, не изменился ли статус задач. Если статус поменялся - мы должны оповестить об этом исполнителя или постановщика задачи с помощью push-сообщения. Отлеживаются три события:
<code>var UserHasDoneTask</code> - исполнитель изменил статус задачи на "Выполнено"
<code>var BossHasCloseTask</code> - постановщик изменил статус задачи на "закрыто"
<code>var BossHasntDone</code> - постановщик изменил статус задачи на "Не выполнено", то есть остался неудовлетворен результатом выполнения задачи и послал задачу на доработку.
данные события отправляются в скрипт на сервере, с помощью метода <code>alertUser</code>:</p>
<p><div class="codehilite"><pre><span></span><span class="c1">//send push to user/boss, if the task has changes done/close status</span>
<span class="kd">func</span> <span class="nf">alertUser</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">userId</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">userName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">taskName</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">guard</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nv">rolesQuery</span> <span class="p">=</span> <span class="n">SCQuery</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;roles&quot;</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nv">usersQuery</span> <span class="p">=</span> <span class="n">SCQuery</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;users&quot;</span><span class="p">)</span>
        <span class="n">rolesQuery</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">SCString</span><span class="p">(</span><span class="s">&quot;boss&quot;</span><span class="p">))</span>
        <span class="n">rolesQuery</span><span class="p">.</span><span class="n">fields</span><span class="p">([</span><span class="s">&quot;_id&quot;</span><span class="p">])</span>
        <span class="n">rolesQuery</span><span class="p">.</span><span class="bp">find</span> <span class="p">{</span> <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">roleBossId</span> <span class="p">=</span> <span class="p">(</span><span class="n">result</span><span class="p">?.</span><span class="n">values</span><span class="p">.</span><span class="bp">first</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])?[</span><span class="s">&quot;_id&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                <span class="n">usersQuery</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s">&quot;roles&quot;</span><span class="p">,</span> <span class="n">SCArray</span><span class="p">(</span><span class="n">stringArray</span><span class="p">:</span> <span class="p">[</span><span class="n">roleBossId</span><span class="p">]))</span>
                <span class="n">usersQuery</span><span class="p">.</span><span class="bp">find</span><span class="p">({</span> <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">in</span>
                    <span class="k">if</span> <span class="n">success</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">bossId</span> <span class="p">=</span> <span class="p">(</span><span class="n">result</span><span class="p">?.</span><span class="n">values</span><span class="p">.</span><span class="bp">first</span> <span class="kc">as</span><span class="p">?</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">Any</span><span class="p">])?[</span><span class="s">&quot;_id&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">{</span>
                        <span class="kd">let</span> <span class="nv">pool</span> <span class="p">=</span> <span class="p">[</span><span class="s">&quot;mode&quot;</span><span class="p">:</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;userId&quot;</span><span class="p">:</span><span class="n">userId</span><span class="p">,</span> <span class="s">&quot;userName&quot;</span><span class="p">:</span><span class="n">userName</span><span class="p">,</span> <span class="s">&quot;taskName&quot;</span><span class="p">:</span><span class="n">taskName</span><span class="p">,</span> <span class="s">&quot;bossId&quot;</span><span class="p">:</span> <span class="n">bossId</span><span class="p">]</span>

                        <span class="kd">let</span> <span class="nv">script</span> <span class="p">=</span> <span class="n">SCScript</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">kTaskChangeStatusSendPushScriptID</span><span class="p">)</span>
                        <span class="n">script</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">pool</span><span class="p">:</span> <span class="n">pool</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
                            <span class="k">if</span> <span class="n">success</span> <span class="p">{</span>
                                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;script </span><span class="si">\(</span><span class="kc">self</span><span class="p">.</span><span class="n">kTaskChangeStatusSendPushScriptID</span><span class="si">)</span><span class="s"> was executed.&quot;</span><span class="p">)</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                                <span class="bp">print</span><span class="p">(</span><span class="n">error</span><span class="p">!)</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

Данный метод запускает скрипт на сервере, передав ему тип события. Передавать параметры скрипту можно с помощью словаря <code>pool</code>. В данном методе серверному скрипту передаются переменные:
<code>mode</code> -  вид события
<code>userId</code> - идентификатор иполнителя задачи
<code>userName</code> - имя исполнителя задачи
<code>taskName</code> - название задачи
'bossId' - идентификатор поставновщика
Данный метод сначала запрашивает идентификатор роли "boss", потом ищет пользователя с такой ролью. Если пользователь найден - скрипт запускается методом <code>run</code> класса <code>SCScript</code>.</p>
<p>Исходный код скрипта:
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">Scorocode</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;scorocode&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">UserHasDoneTask</span> <span class="o">=</span> <span class="s2">&quot; выполнил задачу: &quot;</span>
<span class="kd">var</span> <span class="nx">BossHasCloseTask</span> <span class="o">=</span> <span class="s2">&quot;Босс закрыл задачу: &quot;</span>
<span class="kd">var</span> <span class="nx">BossHasntDone</span> <span class="o">=</span> <span class="s2">&quot;Босс не одобрил выполнение задачи: &quot;</span>

<span class="nx">Scorocode</span><span class="p">.</span><span class="nx">Init</span><span class="p">({</span>
    <span class="nx">ApplicationID</span><span class="o">:</span> <span class="s2">&quot;98bc4bacb5edea727cfb8fae25f71b59&quot;</span><span class="p">,</span>
    <span class="nx">JavaScriptKey</span><span class="o">:</span> <span class="s2">&quot;24d0d42ab02cf546b88b9134cf1d1468&quot;</span><span class="p">,</span>
    <span class="nx">FileKey</span><span class="o">:</span> <span class="s2">&quot;351cb3d71efef69e346ac5657dd16c1c&quot;</span><span class="p">,</span>
    <span class="nx">MessageKey</span><span class="o">:</span> <span class="s2">&quot;35d5a173e0391ae83d60a6a756a44051&quot;</span>
<span class="p">});</span>


<span class="nx">userClosedTask</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">userClosedTask</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// user has closed the task</span>
    <span class="kd">var</span> <span class="nx">Devices</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scorocode</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">Broadcast</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scorocode</span><span class="p">.</span><span class="nx">Messenger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">userId</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="kd">var</span> <span class="nx">bossId</span> <span class="o">=</span> <span class="nx">pool</span><span class="p">[</span><span class="s2">&quot;bossId&quot;</span><span class="p">]</span>
    <span class="kd">var</span> <span class="nx">userName</span> <span class="o">=</span> <span class="nx">pool</span><span class="p">[</span><span class="s2">&quot;userName&quot;</span><span class="p">]</span>
    <span class="kd">var</span> <span class="nx">taskName</span> <span class="o">=</span> <span class="nx">pool</span><span class="p">[</span><span class="s2">&quot;taskName&quot;</span><span class="p">]</span>
    <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="kd">var</span> <span class="nx">mode</span> <span class="o">=</span> <span class="nx">pool</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pool</span><span class="p">)</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">&#39;BossHasCloseTask&#39;</span><span class="o">:</span>
        <span class="nx">userId</span> <span class="o">=</span> <span class="nx">pool</span><span class="p">[</span><span class="s2">&quot;userId&quot;</span><span class="p">]</span>
        <span class="nx">text</span> <span class="o">=</span> <span class="nx">BossHasCloseTask</span> <span class="o">+</span> <span class="nx">taskName</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;BossHasntDone&#39;</span><span class="o">:</span>
        <span class="nx">userId</span> <span class="o">=</span> <span class="nx">pool</span><span class="p">[</span><span class="s2">&quot;userId&quot;</span><span class="p">]</span>
        <span class="nx">text</span> <span class="o">=</span> <span class="nx">BossHasntDone</span> <span class="o">+</span> <span class="nx">taskName</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;UserHasDoneTask&#39;</span><span class="o">:</span>
        <span class="nx">userId</span> <span class="o">=</span> <span class="nx">bossId</span>
        <span class="nx">text</span> <span class="o">=</span> <span class="nx">userName</span> <span class="o">+</span> <span class="nx">UserHasDoneTask</span> <span class="o">+</span> <span class="nx">taskName</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="c1">//send push to boss</span>
    <span class="nx">Devices</span><span class="p">.</span><span class="nx">equalTo</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">,</span> <span class="nx">userId</span><span class="p">)</span>
        <span class="nx">Broadcast</span><span class="p">.</span><span class="nx">sendPush</span><span class="p">({</span>
            <span class="nx">where</span><span class="o">:</span> <span class="nx">Devices</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="o">:</span> <span class="nx">text</span><span class="p">}</span><span class="c1">//text}</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">success</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;success!&quot;</span><span class="p">);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">success</span><span class="p">);</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;error!&quot;</span><span class="p">);</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
            <span class="p">});</span>

<span class="p">}</span>
</pre></div>
</p>
<p>Подробную информацию о написании серверных скриптов вы можете найти на портале документации к Scorocode <a href="http://scorocode.github.io/scorocode-docs/JS/javascript/">http://scorocode.github.io/scorocode-docs/JS/javascript/</a></p>
<p>Добавим так же обработчик нажатия на кнопку "Сохранить":
<div class="codehilite"><pre><span></span> <span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">buttonSaveTouchUpInside</span><span class="p">(</span><span class="kc">_</span> <span class="n">sender</span><span class="p">:</span> <span class="nb">AnyObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//set task params</span>
        <span class="kd">let</span> <span class="nv">newTask</span> <span class="p">=</span> <span class="n">Task</span><span class="p">()</span>
        <span class="n">newTask</span><span class="p">.</span><span class="n">user</span> <span class="p">=</span> <span class="n">userList</span><span class="p">[</span><span class="n">pickerViewUsers</span><span class="p">.</span><span class="n">selectedRow</span><span class="p">(</span><span class="n">inComponent</span><span class="p">:</span> <span class="mi">0</span><span class="p">)].</span><span class="n">id</span>
        <span class="n">newTask</span><span class="p">.</span><span class="n">username</span> <span class="p">=</span> <span class="n">userList</span><span class="p">[</span><span class="n">pickerViewUsers</span><span class="p">.</span><span class="n">selectedRow</span><span class="p">(</span><span class="n">inComponent</span><span class="p">:</span> <span class="mi">0</span><span class="p">)].</span><span class="n">name</span>
        <span class="n">newTask</span><span class="p">.</span><span class="n">bossComment</span> <span class="p">=</span> <span class="n">textViewBossComment</span><span class="p">.</span><span class="n">text</span>
        <span class="n">newTask</span><span class="p">.</span><span class="n">closeDate</span> <span class="p">=</span> <span class="n">datePickerDate</span><span class="p">.</span><span class="n">date</span>
        <span class="n">newTask</span><span class="p">.</span><span class="n">comment</span> <span class="p">=</span> <span class="n">textViewComment</span><span class="p">.</span><span class="n">text</span>
        <span class="n">newTask</span><span class="p">.</span><span class="n">detailed</span> <span class="p">=</span> <span class="n">textViewDetailed</span><span class="p">.</span><span class="n">text</span>
        <span class="k">if</span> <span class="n">isCreateMode</span> <span class="p">{</span>
            <span class="n">newTask</span><span class="p">.</span><span class="n">isClose</span> <span class="p">=</span> <span class="kc">false</span>
            <span class="n">newTask</span><span class="p">.</span><span class="n">isDone</span> <span class="p">=</span> <span class="kc">false</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">newTask</span><span class="p">.</span><span class="n">isClose</span> <span class="p">=</span> <span class="n">switchIsClosed</span><span class="p">.</span><span class="n">isOn</span>
            <span class="n">newTask</span><span class="p">.</span><span class="n">isDone</span> <span class="p">=</span> <span class="n">switchIsDone</span><span class="p">.</span><span class="n">isOn</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">text</span> <span class="p">=</span> <span class="n">textFieldTaskName</span><span class="p">.</span><span class="n">text</span> <span class="p">{</span>
            <span class="n">newTask</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">text</span>
        <span class="p">}</span>
        <span class="n">newTask</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">id</span>
        <span class="c1">//creating new task document or update</span>
        <span class="kd">let</span> <span class="nv">scObject</span> <span class="p">=</span> <span class="n">isCreateMode</span> <span class="p">?</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;tasks&quot;</span><span class="p">)</span> <span class="p">:</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;tasks&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">:</span> <span class="n">task</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">scObject</span><span class="p">.</span><span class="kr">set</span><span class="p">([</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s">&quot;Done&quot;</span><span class="p">:</span> <span class="n">SCBool</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">isDone</span><span class="p">),</span>
            <span class="s">&quot;Closed&quot;</span><span class="p">:</span> <span class="n">SCBool</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">isClose</span><span class="p">),</span>
            <span class="s">&quot;comment&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">comment</span><span class="p">),</span>
            <span class="s">&quot;closeDate&quot;</span><span class="p">:</span> <span class="n">SCDate</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">closeDate</span><span class="p">),</span>
            <span class="s">&quot;detailed&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">detailed</span><span class="p">),</span>
            <span class="s">&quot;bossComment&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">bossComment</span><span class="p">),</span>
            <span class="s">&quot;user&quot;</span><span class="p">:</span> <span class="n">SCString</span><span class="p">(</span><span class="n">newTask</span><span class="p">.</span><span class="n">user</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="c1">//try to create or update</span>
        <span class="n">activityIndicator</span><span class="p">.</span><span class="n">startAnimating</span><span class="p">()</span>
        <span class="n">contentView</span><span class="p">.</span><span class="n">isUserInteractionEnabled</span> <span class="p">=</span> <span class="kc">false</span>
        <span class="n">scObject</span><span class="p">.</span><span class="n">save</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span> <span class="k">in</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">activityIndicator</span><span class="p">.</span><span class="n">stopAnimating</span><span class="p">()</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">contentView</span><span class="p">.</span><span class="n">isUserInteractionEnabled</span> <span class="p">=</span> <span class="kc">true</span>
            <span class="k">if</span> <span class="n">success</span> <span class="p">{</span>
                <span class="c1">// get task id</span>
                <span class="k">if</span> <span class="kc">self</span><span class="p">.</span><span class="n">isCreateMode</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="kd">let</span> <span class="nv">id</span> <span class="p">=</span> <span class="n">result</span><span class="p">?[</span><span class="s">&quot;_id&quot;</span><span class="p">]</span> <span class="kc">as</span><span class="p">?</span> <span class="nb">String</span> <span class="p">{</span>
                        <span class="n">newTask</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">id</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">saveHistory</span><span class="p">(</span><span class="n">newTask</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Ошибка!&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Не удалось сохранить задачу. Попробуйте еще раз&quot;</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

 Обработчик создает новую задачу, записывает в нее требуемые поля, и пытается сохранить или обновить соотвествующий документ задачи на сервере. Напомним, то при обновлении длокумента на сервере необходимо инициализировать класс <code>SCObject</code> с идентификатором:
 ```SWIFT
SCObject(collection: "tasks", id: task.id)</p>
<div class="codehilite"><pre><span></span>При сохранении документа на сервер в случае успеха сервер посылает ответ содержащий идентификатор документа. Мы можем воспользоватся этим и сохранить нужный нам идентификатор задачи, если мы создаем нову задачу, дабы не делать еще один запрос к серверу:
```SWIFT
scObject.save() {
            success, error, result in
            self.activityIndicator.stopAnimating()
            self.contentView.isUserInteractionEnabled = true
            if success {
                // get task id
                if self.isCreateMode {
                    if let id = result?[&quot;_id&quot;] as? String {
                        newTask.id = id
                    }
                }
                self.saveHistory(newTask)
            } else {
               self.showAlert(title: &quot;Ошибка!&quot;, message: &quot;Не удалось сохранить задачу. Попробуйте еще раз&quot;, completion: nil)
            }
        }
</pre></div>


<p>Добавм обработчик нажатия на кнопку "Удалить задачу":</p>
<p><div class="codehilite"><pre><span></span><span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">buttonDeleteTap</span><span class="p">(</span><span class="kc">_</span> <span class="n">sender</span><span class="p">:</span> <span class="nb">Any</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">scObject</span> <span class="p">=</span> <span class="n">SCObject</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;tasks&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">:</span> <span class="n">task</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">scObject</span><span class="p">.</span><span class="n">remove</span> <span class="p">{</span> <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">if</span> <span class="n">success</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nv">scQuery</span> <span class="p">=</span> <span class="n">SCQuery</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="s">&quot;history&quot;</span><span class="p">)</span>
                <span class="n">scQuery</span><span class="p">.</span><span class="n">equalTo</span><span class="p">(</span><span class="s">&quot;task&quot;</span><span class="p">,</span> <span class="n">SCString</span><span class="p">(</span><span class="kc">self</span><span class="p">.</span><span class="n">task</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
                <span class="n">scQuery</span><span class="p">.</span><span class="n">remove</span><span class="p">({</span> <span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">in</span>
                    <span class="k">if</span> <span class="n">success</span> <span class="p">{</span>
                        <span class="kc">self</span><span class="p">.</span><span class="n">showAlert</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&quot;Успешно&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&quot;Задача и ее история удалена&quot;</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kc">self</span><span class="p">.</span><span class="n">navigationController</span><span class="p">?.</span><span class="n">popViewController</span><span class="p">(</span><span class="n">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

Обработчик делает запрос к серверу на удаление документа задачи. Также, в случае успеха, удаляется и вся история, связанная с удаленной задачей.</p>
<h3 id="_8">Скрипт оповещения постановщика задач о просроченных сроках</h3>
<p>Добавим на сервер скрипт:
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">Scorocode</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;scorocode&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bossId</span> <span class="o">=</span> <span class="s2">&quot;qRmX5rHsc6&quot;</span>

<span class="nx">Scorocode</span><span class="p">.</span><span class="nx">Init</span><span class="p">({</span>
    <span class="nx">ApplicationID</span><span class="o">:</span> <span class="s2">&quot;98bc4bacb5edea727cfb8fae25f71b59&quot;</span><span class="p">,</span>
    <span class="nx">JavaScriptKey</span><span class="o">:</span> <span class="s2">&quot;24d0d42ab02cf546b88b9134cf1d1468&quot;</span><span class="p">,</span>
    <span class="nx">FileKey</span><span class="o">:</span> <span class="s2">&quot;351cb3d71efef69e346ac5657dd16c1c&quot;</span><span class="p">,</span>
    <span class="nx">MessageKey</span><span class="o">:</span> <span class="s2">&quot;35d5a173e0391ae83d60a6a756a44051&quot;</span>
<span class="p">});</span>

<span class="nx">alertBossAboutExpiredTasks</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">alertBossAboutExpiredTasks</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Создадим новый экземпляр запроса к коллекции Tasks</span>
<span class="kd">var</span> <span class="nx">Tasks</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scorocode</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="s2">&quot;tasks&quot;</span><span class="p">);</span> 
<span class="kd">var</span> <span class="nx">TasksIsDone</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scorocode</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="s2">&quot;tasks&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">TasksIsClosed</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scorocode</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="s2">&quot;tasks&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">TasksIsOver</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scorocode</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="s2">&quot;tasks&quot;</span><span class="p">);</span>
<span class="c1">// Установим условие выборки - запросить все объекты, с истекшим сроком</span>
<span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
<span class="nx">TasksIsOver</span><span class="p">.</span><span class="nx">lessThan</span><span class="p">(</span><span class="s2">&quot;closeDate&quot;</span><span class="p">,</span> <span class="nx">now</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">())</span> 
<span class="c1">// Установим условие выборки - запросить все выполненные пользователем задачи</span>
<span class="nx">TasksIsDone</span><span class="p">.</span><span class="nx">notEqualTo</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="c1">// Установим условие выборки - запросить все закрытые боссом задачи</span>
<span class="nx">TasksIsClosed</span><span class="p">.</span><span class="nx">notEqualTo</span><span class="p">(</span><span class="s2">&quot;Closed&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="nx">Tasks</span><span class="p">.</span><span class="nx">and</span><span class="p">(</span><span class="nx">TasksIsDone</span><span class="p">).</span><span class="nx">and</span><span class="p">(</span><span class="nx">TasksIsClosed</span><span class="p">).</span><span class="nx">and</span><span class="p">(</span><span class="nx">TasksIsOver</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">find</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">result</span><span class="p">)</span>
            <span class="nx">parseQueryResultAndSendPushToBoss</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">result</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">parseQueryResultAndSendPushToBoss</span><span class="p">(</span><span class="nx">queryResult</span><span class="p">)</span>  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Broadcast</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scorocode</span><span class="p">.</span><span class="nx">Messenger</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">Devices</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scorocode</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">expiredTasks</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">queryResult</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">textMessage</span> <span class="o">=</span> <span class="s2">&quot;Просрочена задача: \&quot;&quot;</span> <span class="o">+</span> <span class="nx">queryResult</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span>
        <span class="nx">expiredTasks</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="s2">&quot;text&quot;</span><span class="o">:</span><span class="nx">textMessage</span><span class="p">,</span><span class="s2">&quot;userid&quot;</span><span class="o">:</span><span class="nx">queryResult</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">user</span><span class="p">})</span>
    <span class="p">}</span>
    <span class="c1">//send to boss expired tasks</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">expiredTasks</span><span class="p">)</span> <span class="p">{</span>    
        <span class="kd">var</span> <span class="nx">task</span> <span class="o">=</span> <span class="nx">expiredTasks</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">task</span><span class="p">[</span><span class="s2">&quot;userid&quot;</span><span class="p">]</span>    
        <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">task</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">text</span><span class="p">)</span>
        <span class="nx">Devices</span><span class="p">.</span><span class="nx">equalTo</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">,</span> <span class="nx">bossId</span><span class="p">)</span>
        <span class="nx">Broadcast</span><span class="p">.</span><span class="nx">sendPush</span><span class="p">({</span>
            <span class="nx">where</span><span class="o">:</span> <span class="nx">Devices</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="o">:</span> <span class="nx">text</span><span class="p">}</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">success</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;success!&quot;</span><span class="p">);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">success</span><span class="p">);</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;error!&quot;</span><span class="p">);</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
            <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

Данный скрипт поставим на периодический запуск какждые 10 минут. Скрипт будет автоматически запускаться, проверять статус задач и оповещать постановщика задач push-уведомлением. Настроить расписание запуска скрипта можно на вкладке "Настройки" скрипта.</p>
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../Java/Storehouse/" title="Склад (Android)" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Склад (Android)
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/scorocode" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://www.facebook.com/scorocode" class="md-footer-social__link fa fa-facebook"></a>
    
      <a href="https://www.linkedin.com/company/prof-it-group" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-2afe21e0b2.js"></script>
      <script>var config={url:{base:"../.."}},app=new Application(config);app.initialize()</script>
      
    
    
      
    
  </body>
</html>