<!DOCTYPE html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      <title>Склад (Android) - Документация Scorocode</title>
    
    
    
    
    <meta name="generator" content="mkdocs+mkdocs-material#0.2.1">
    <script src="../../assets/javascripts/modernizr-dede1352ed.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono:400">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="../../assets/stylesheets/application.css">
    
  </head>
  <body>
    <input class="md-toggle md-toggle--drawer" type="checkbox" id="drawer">
    <input class="md-toggle md-toggle--search" type="checkbox" id="search">
    <label class="md-overlay" for="drawer"></label>
    <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Документация Scorocode" class="md-icon md-header-nav__icon md-header-nav__icon--home">
          layers
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-header-nav__icon md-header-nav__icon--menu" for="drawer">
          menu
        </label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          Склад (Android)
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-header-nav__icon md-header-nav__icon--search" for="search">
          search
        </label>
        <div class="md-search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form">
      <input type="text" class="md-search__input" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" id="query">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap">
        <div class="md-search-result">
          <div class="md-search-result__meta">
            Indexing
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
        </div>
      </div>
    </div>
  </nav>
</header>
    <div class="md-container">
      <main class="md-main">
        <div class="md-main__inner md-grid">
          
          
            <div class="md-sidebar md-sidebar--primary" data-md-sidebar="primary">
              <div class="md-sidebar__scrollwrap">
                <div class="md-sidebar__inner">
                  <nav class="md-nav md-nav--primary">
  <label class="md-nav__title" for="drawer">Документация Scorocode</label>
  <ul class="md-nav__list">
    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Scorocode
    </label>
    <nav class="md-nav" data-md-collapse>
      <label class="md-nav__title" for="nav-1">
        Scorocode
      </label>
      <ul class="md-nav__list">
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../.." title="Общие сведения" class="md-nav__link">
        Общие сведения
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../main/main1/" title="Начало работы" class="md-nav__link">
        Начало работы
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../main/main2/" title="Личный кабинет" class="md-nav__link">
        Личный кабинет
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app/" title="Работа с приложением" class="md-nav__link">
        Работа с приложением
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app1/" title="Аналитика приложения" class="md-nav__link">
        Аналитика приложения
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app2/" title="Данные приложения" class="md-nav__link">
        Данные приложения
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app3/" title="Индексы" class="md-nav__link">
        Индексы
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app4/" title="Триггеры" class="md-nav__link">
        Триггеры
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app5/" title="Серверный код приложения" class="md-nav__link">
        Серверный код приложения
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../app/bots/" title="Боты Telegram" class="md-nav__link">
        Боты Telegram
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../app/app6/" title="Настройки приложения" class="md-nav__link">
        Настройки приложения
      </a>
    
  </li>

          
        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      HTTP API
    </label>
    <nav class="md-nav" data-md-collapse>
      <label class="md-nav__title" for="nav-2">
        HTTP API
      </label>
      <ul class="md-nav__list">
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/appapi/" title="Работа с приложением" class="md-nav__link">
        Работа с приложением
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi1/" title="Пользователи" class="md-nav__link">
        Пользователи
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi2/" title="Данные" class="md-nav__link">
        Данные
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi3/" title="Файлы" class="md-nav__link">
        Файлы
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi4/" title="Сообщения" class="md-nav__link">
        Сообщения
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi5/" title="Скрипты" class="md-nav__link">
        Скрипты
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../httpapi/httpapi6/" title="Статистика" class="md-nav__link">
        Статистика
      </a>
    
  </li>

          
        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      JavaScript SDK
    </label>
    <nav class="md-nav" data-md-collapse>
      <label class="md-nav__title" for="nav-3">
        JavaScript SDK
      </label>
      <ul class="md-nav__list">
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/javascript/" title="JavaScript SDK" class="md-nav__link">
        JavaScript SDK
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode/" title="Scorocode" class="md-nav__link">
        Scorocode
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.Object/" title="Scorocode.Object" class="md-nav__link">
        Scorocode.Object
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.Query/" title="Scorocode.Query" class="md-nav__link">
        Scorocode.Query
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.UpdateOps/" title="Scorocode.UpdateOps" class="md-nav__link">
        Scorocode.UpdateOps
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.User/" title="Scorocode.User" class="md-nav__link">
        Scorocode.User
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.Messenger/" title="Scorocode.Messenger" class="md-nav__link">
        Scorocode.Messenger
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.CloudCode/" title="Scorocode.CloudCode" class="md-nav__link">
        Scorocode.CloudCode
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.Bot/" title="Scorocode.Bot" class="md-nav__link">
        Scorocode.Bot
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../JS/Scorocode.Websocket/" title="Scorocode.WebSocket" class="md-nav__link">
        Scorocode.WebSocket
      </a>
    
  </li>

          
        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      SWIFT SDK (iOs, Mac OS)
    </label>
    <nav class="md-nav" data-md-collapse>
      <label class="md-nav__title" for="nav-4">
        SWIFT SDK (iOs, Mac OS)
      </label>
      <ul class="md-nav__list">
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../SWIFT/SWIFT/" title="SWIFT SDK" class="md-nav__link">
        SWIFT SDK
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../SWIFT/SC/" title="SC" class="md-nav__link">
        SC
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../SWIFT/SCValue/" title="SCValue" class="md-nav__link">
        SCValue
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../SWIFT/SCObject/" title="SCObject" class="md-nav__link">
        SCObject
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../SWIFT/SCQuery/" title="SCQuery" class="md-nav__link">
        SCQuery
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../SWIFT/SCUpdate/" title="SCUpdate" class="md-nav__link">
        SCUpdate
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../SWIFT/SCUser/" title="SCUser" class="md-nav__link">
        SCUser
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../SWIFT/SCMessage/" title="SCMessage" class="md-nav__link">
        SCMessage
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../SWIFT/SCScript/" title="SCScript" class="md-nav__link">
        SCScript
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../../SWIFT/WebSocket/" title="WebSocket" class="md-nav__link">
        WebSocket
      </a>
    
  </li>

          
        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Java SDK (Android)
    </label>
    <nav class="md-nav" data-md-collapse>
      <label class="md-nav__title" for="nav-5">
        Java SDK (Android)
      </label>
      <ul class="md-nav__list">
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../Java/" title="Java SDK" class="md-nav__link">
        Java SDK
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../ScorocodeSDK/" title="Класс ScorocodeSDK" class="md-nav__link">
        Класс ScorocodeSDK
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../Document/" title="Класс Document" class="md-nav__link">
        Класс Document
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../Update/" title="Класс Update" class="md-nav__link">
        Класс Update
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../User/" title="Класс User" class="md-nav__link">
        Класс User
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../Query/" title="Класс Query" class="md-nav__link">
        Класс Query
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../Script/" title="Класс Script" class="md-nav__link">
        Класс Script
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../Message/" title="Класс Message" class="md-nav__link">
        Класс Message
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../WebSocket/" title="Класс WebSocket" class="md-nav__link">
        Класс WebSocket
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../ApplicationInfo/" title="Класс ApplicationInfo" class="md-nav__link">
        Класс ApplicationInfo
      </a>
    
  </li>

          
        
          
          
          
  <li class="md-nav__item">
    
      <a href="../Bot/" title="Класс Bot" class="md-nav__link">
        Класс Bot
      </a>
    
  </li>

          
        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Примеры приложений
    </label>
    <nav class="md-nav" data-md-collapse>
      <label class="md-nav__title" for="nav-6">
        Примеры приложений
      </label>
      <ul class="md-nav__list">
        
          
          
          
  <li class="md-nav__item">
    <input class="md-toggle md-nav__toggle" type="checkbox" id="toc">
    <label class="md-nav__link md-nav__link--active" for="toc">
      Склад (Android)
    </label>
    <a href="./" title="Склад (Android)" class="md-nav__link md-nav__link--active">
      Склад (Android)
    </a>
    <nav class="md-nav md-nav--secondary">
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list">
      
        <li class="md-nav__item">
  <a href="#_2" title="Структура данных приложения:" class="md-nav__link">
    Структура данных приложения:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="Стартовый экран приложения." class="md-nav__link">
    Стартовый экран приложения.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" title="Экран регистрации нового пользователя" class="md-nav__link">
    Экран регистрации нового пользователя
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" title="Главный экран приложения." class="md-nav__link">
    Главный экран приложения.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" title="Экран добавления устройства" class="md-nav__link">
    Экран добавления устройства
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" title="Экран подробной информации о устройстве." class="md-nav__link">
    Экран подробной информации о устройстве.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" title="Экран информации об отгрузке товара." class="md-nav__link">
    Экран информации об отгрузке товара.
  </a>
  
</li>
      
    </ul>
  
</nav>
  </li>

          
        
      </ul>
    </nav>
  </li>

    
  </ul>
  
</nav>
                </div>
              </div>
            </div>
          
          
            <div class="md-sidebar md-sidebar--secondary" data-md-sidebar="secondary">
              <div class="md-sidebar__scrollwrap">
                <div class="md-sidebar__inner">
                  <nav class="md-nav md-nav--secondary">
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list">
      
        <li class="md-nav__item">
  <a href="#_2" title="Структура данных приложения:" class="md-nav__link">
    Структура данных приложения:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="Стартовый экран приложения." class="md-nav__link">
    Стартовый экран приложения.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" title="Экран регистрации нового пользователя" class="md-nav__link">
    Экран регистрации нового пользователя
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" title="Главный экран приложения." class="md-nav__link">
    Главный экран приложения.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" title="Экран добавления устройства" class="md-nav__link">
    Экран добавления устройства
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" title="Экран подробной информации о устройстве." class="md-nav__link">
    Экран подробной информации о устройстве.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" title="Экран информации об отгрузке товара." class="md-nav__link">
    Экран информации об отгрузке товара.
  </a>
  
</li>
      
    </ul>
  
</nav>
                </div>
              </div>
            </div>
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                <p><a name="Storehouse"></a></p>
<h1 id="_1">Приложение "Склад"<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>Данная документация содержит описание демонстрационного приложения "Склад". Исходный код приложения доступен в репозитории <a href="https://github.com/Scorocode/scorocode-sample-storehouse">https://github.com/Scorocode/scorocode-sample-storehouse</a>.</p>
<p>Данное приложение проводит учет мобильных телефонов на складе поставщика и позволяет:</p>
<ol>
<li>Зарегистрировать нового пользователя в БД приложения</li>
<li>Провести аутентификацию пользователя приложения</li>
<li>Провести деаутентификацию пользователя приложения.</li>
<li>Посмотреть доступные модели телефонов на складе</li>
<li>Добавить модель телефона в БД</li>
<li>Удалить модель телефона из БД</li>
<li>Посмотреть подробную информацию о модели телефона</li>
<li>Изменить информацию о модели телефона</li>
<li>Выбрать интересующие модели из списка используя фильтр</li>
<li>Добавить пользователя в лист ожидания данной модели</li>
<li>Отгрузить данную модель телефона пользователю</li>
<li>Оповестить об отгрузке бухгалтерию при помощи email сообщения</li>
<li>Оповестить грузчика при помощи push сообщения.</li>
<li>Оповестить курьера при помощи sms сообщения.</li>
<li>Провести пересчет баланса фирмы с учетом отгруженных к данному моменту моделей.</li>
</ol>
<h2 id="_2">Структура данных приложения:<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Создана коллекция <code>storehouse</code> со следующими полями:</p>
<ol>
<li>platform (String)</li>
<li>cameraInfo (String)</li>
<li>deviceName (String)</li>
<li>colorsAvailable (Array)</li>
<li>devicePrice (Number)</li>
<li>buyers (Array)</li>
<li>lastSend (Date)</li>
<li>sendInfo (File)</li>
</ol>
<p>В системную коллекцию <code>Roles</code> добавлены 3 документа со следующими значениями поля <code>name</code> соответственно:</p>
<ol>
<li>deliveryPerson</li>
<li>accountantPerson</li>
<li>loaderPerson</li>
</ol>
<h2 id="_3">Стартовый экран приложения.<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>Создадим стартовый экран приложения с именем <code>LoginActivity</code>. Для этого в Android Studio выберем <code>File → New → Activity → Empty Activity</code> и в layout-файл данной активности добавим следующий код:</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;RelativeLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/activity_login&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:paddingBottom=</span><span class="s">&quot;@dimen/activity_vertical_margin&quot;</span>
    <span class="na">android:paddingLeft=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingRight=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingTop=</span><span class="s">&quot;@dimen/activity_vertical_margin&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;prof_itgroup.ru.storehouseapp.Activities.LoginActivity&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center&quot;</span>
        <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;16dp&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/login&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;EditText</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/etEmail&quot;</span>
            <span class="na">android:gravity=</span><span class="s">&quot;center&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
            <span class="na">android:hint=</span><span class="s">&quot;@string/login_hint&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;16dp&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/password&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;EditText</span>
            <span class="na">android:gravity=</span><span class="s">&quot;center&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/etPassword&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
            <span class="na">android:hint=</span><span class="s">&quot;@string/password_hint&quot;</span>
            <span class="na">android:inputType=</span><span class="s">&quot;textPassword&quot;</span>
            <span class="na">android:maxLines=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;LinearLayout</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
            <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;Button</span>
                <span class="na">android:id=</span><span class="s">&quot;@+id/btnLogin&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_marginTop=</span><span class="s">&quot;4dp&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;@string/login_button_text&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;Button</span>
                <span class="na">android:id=</span><span class="s">&quot;@+id/btnRegister&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_marginTop=</span><span class="s">&quot;4dp&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;@string/register_button_text&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/LinearLayout&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>
<span class="nt">&lt;/RelativeLayout&gt;</span>
</pre></div>


<p>Стартовый экран приложения, соответствующий классу <code>LoginActivity</code>, показан на рисунке 1.1. </p>
<p><img alt="Cтартовый экран приложения" src="../img/Storehouse/1.1.png" /></p>
<p>Рисунок 1.1 – стартовый экран приложения.</p>
<p>В метод <code>onCreate</code> класса <code>LoginActivity</code> добавим следующий код:</p>
<div class="codehilite"><pre><span></span><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_login</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isUserLogined</span><span class="o">(</span><span class="k">this</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">MainActivity</span><span class="o">.</span><span class="na">display</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">ScorocodeSdk</span><span class="o">.</span><span class="na">initWith</span><span class="o">(</span><span class="n">APPLICATION_ID</span><span class="o">,</span> <span class="n">CLIENT_KEY</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">FILE_KEY</span><span class="o">,</span> <span class="n">MESSAGE_KEY</span><span class="o">,</span> <span class="n">SCRIPT_KEY</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">ButterKnife</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p>В методе <code>onCreate</code> данного класса происходит инициализация <code>ScorocodeSdk</code> ключами <code>appId</code>, <code>clientKey</code> (android), <code>fileKey</code>, <code>messageKey</code>, <code>scriptKey</code> при помощи метода <code>ScorocodeSdk.initWith(...)</code>; Посмотреть данные ключи можно на вкладке «Безопасность» настроек проекта.</p>
<p>На данном экране пользователь БД может ввести свой логин и пароль и системе. Приложения проведет проверку правильности введенных данных при помощи метода <code>.login()</code> класса <code>User</code>. Использование данного метода показано в листинге:</p>
<div class="codehilite"><pre><span></span><span class="nd">@OnClick</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btnLogin</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBtnLoginClicked</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
    <span class="n">user</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">etEmail</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">etPassword</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="k">new</span> <span class="n">CallbackLoginUser</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLoginSucceed</span><span class="o">(</span><span class="n">ResponseLogin</span> <span class="n">responseLogin</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">DocumentInfo</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="n">responseLogin</span><span class="o">.</span><span class="na">getResult</span><span class="o">().</span><span class="na">getUserInfo</span><span class="o">();</span>
            <span class="n">saveUserInfo</span><span class="o">(</span><span class="n">userInfo</span><span class="o">);</span>
            <span class="n">MainActivity</span><span class="o">.</span><span class="na">display</span><span class="o">(</span><span class="n">LoginActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLoginFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_login</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>


<p>В данном методе мы создаем новый экземпляр класса <code>User</code> и вызываем его метод <code>login</code> при этом информацию о email и password пользователя мы берем из соответствующих <code>EditText</code>. Метод <code>login</code> проверит тот факт, что пользователь с таким email и паролем существует в коллекции «users».</p>
<p>В случае если в коллекции «users» имеется пользователь с указанными email и password, то будет выполнен метод <code>onLoginSucceed(...) callback</code> интерфейса иначе - <code>onFoginFailed(...)</code>. Таким образом мы можем удостовериться в наличии пользователя с такими данными в нашей БД и принять дальнейшие действия.</p>
<p>На стартовом экране (показанном на рисунке 1.1) так же имеется кнопка «Зарегистрировать» позволяющая зарегистрировать нового пользователя в системе (добавить его в коллекцию «users» БД). Привяжем к данной кнопке обработчик нажатия который открывает активность с данными для регистрации пользователя:</p>
<div class="codehilite"><pre><span></span><span class="nd">@OnClick</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btnRegister</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBtnRegisterClicked</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">RegisterActivity</span><span class="o">.</span><span class="na">display</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<h2 id="_4">Экран регистрации нового пользователя<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>Создадим новую активность с именем <code>RegisterActivity</code> и добавим в layout-файл данной активности следующий xml код:</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/activity_register&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">android:paddingBottom=</span><span class="s">&quot;@dimen/activity_vertical_margin&quot;</span>
    <span class="na">android:paddingLeft=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingRight=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingTop=</span><span class="s">&quot;@dimen/activity_vertical_margin&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;prof_itgroup.ru.storehouseapp.Activities.RegisterActivity&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/register_username&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/etUsername&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:hint=</span><span class="s">&quot;@string/register_username_hint&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">android:layout_marginTop=</span><span class="s">&quot;16dp&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/register_email&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/etEmail&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:hint=</span><span class="s">&quot;@string/register_email_hint&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">android:layout_marginTop=</span><span class="s">&quot;16dp&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/register_password&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/etPassword&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:inputType=</span><span class="s">&quot;textPassword&quot;</span>
        <span class="na">android:hint=</span><span class="s">&quot;@string/register_email_password&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/etPasswordCheck&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:inputType=</span><span class="s">&quot;textPassword&quot;</span>
        <span class="na">android:hint=</span><span class="s">&quot;@string/register_email_password_again&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Button</span>
        <span class="na">android:layout_marginTop=</span><span class="s">&quot;32dp&quot;</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/btnRegister&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/btn_register_text&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>


<p>Данная активность представляет собой экран регистрации нового пользователя, показанный на рисунке 1.2</p>
<p><img alt="Экран регистрации нового пользователя" src="../img/Storehouse/1.2.png" /></p>
<p>Рисунок 1.2 — экран регистрации нового пользователя.</p>
<p>На данном экране вводятся все необходимые поля документа (характеризующие пользователя). Добавим обработчик нажатия для кнопки «Зарегистрировать» вызывающий метод <code>.register</code> класса <code>User</code> для регистрации нового пользователя, показанный ниже:</p>
<div class="codehilite"><pre><span></span><span class="nd">@OnClick</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btnRegister</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBtnRegisterClicked</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">etUsername</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">email</span> <span class="o">=</span> <span class="n">etEmail</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">etPassword</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">passwordCheck</span> <span class="o">=</span> <span class="n">etPasswordCheck</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

    <span class="k">if</span><span class="o">(</span><span class="n">isInputValid</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span> <span class="n">email</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">passwordCheck</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">new</span> <span class="n">User</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span> <span class="n">email</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="k">new</span> <span class="n">CallbackRegisterUser</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRegisterSucceed</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">RegisterActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">register_succeed</span><span class="o">),</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                <span class="n">LoginActivity</span><span class="o">.</span><span class="na">display</span><span class="o">(</span><span class="n">RegisterActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRegisterFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">RegisterActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_register</span><span class="o">),</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">wrong_data</span><span class="o">)</span> <span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>В данном методе мы получаем значения введенные в элементы <code>EditText</code>, а именно: имя пользователя, его email, пароль и пароль повторно (для проверки).</p>
<p>Далее при помощи метода isInputValid мы проверяем, что поля не являются пустыми и что значение, введенное в поля пароля и проверки пароля идентичны, после чего вызываем метод <code>.register</code> класса <code>User</code>.</p>
<p>В случае если регистрация пользователя прошла успешно (т.е если sdk инициализирован, все ключи указаны правильно и нет конфликта с уже существующими пользователями), будет выполнен метод  <code>onRegisterSucceed(...) callback</code> интерфейса иначе будет выполнен метод <code>onRegisterFailed(...)</code>.</p>
<p>В данном случае при успешной регистрации пользователя выдается Toast-сообщение с информацией о том, что пользователь успешно зарегистрирован и открывается активность <code>LoginActivity</code> чтобы пользователь мог аутентифицироваться и приступить к работе с приложением.</p>
<h2 id="_5">Главный экран приложения.<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>Создадим главный экран приложения с именем <code>MainActivity</code> и в layout-файл данной активности добавим следующий xml код:</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;RelativeLayout</span>
    <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/activity_main&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:paddingLeft=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingRight=</span><span class="s">&quot;@dimen/activity_horizontal_margin&quot;</span>
    <span class="na">android:paddingTop=</span><span class="s">&quot;@dimen/activity_vertical_margin&quot;</span>
    <span class="na">android:paddingBottom=</span><span class="s">&quot;@dimen/activity_vertical_margin&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;prof_itgroup.ru.storehouseapp.Activities.MainActivity&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ListView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/lvItemsInStorehouse&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/RelativeLayout&gt;</span>
</pre></div>


<p>Активность представляет собой <code>ListView</code> в который мы передаем информацию о товарах, хранящихся в БД. Кроме того активность содержит иконки <code>ActionBar</code> о которых будет сказано подробней.</p>
<p>Для отображения информации создадим адаптер с именем <code>StoreItemAdapter</code> код которого показан ниже:</p>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">prof_itgroup.ru.storehouseapp.Objects</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.support.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.ViewGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.BaseAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">butterknife.BindView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">butterknife.ButterKnife</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">prof_itgroup.ru.storehouseapp.Activities.ItemDetailsActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">prof_itgroup.ru.storehouseapp.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">ru.profit_group.scorocode_sdk.scorocode_objects.DocumentInfo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StoredItemsAdapter</span> <span class="kd">extends</span> <span class="n">BaseAdapter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Context</span> <span class="n">context</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DocumentInfo</span><span class="o">&gt;</span> <span class="n">storedItems</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">layoutId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">LayoutInflater</span> <span class="n">inflater</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">DocumentFields</span> <span class="n">fields</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">StoredItemsAdapter</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DocumentInfo</span><span class="o">&gt;</span> <span class="n">storedItems</span><span class="o">,</span> <span class="kt">int</span> <span class="n">layoutId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">storedItems</span> <span class="o">=</span> <span class="n">storedItems</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">layoutId</span> <span class="o">=</span> <span class="n">layoutId</span><span class="o">;</span>
        <span class="n">inflater</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DocumentFields</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">storedItems</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getItem</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">storedItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getItemId</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">position</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ViewHolder</span> <span class="n">holder</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">holder</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewHolder</span><span class="o">)</span> <span class="n">view</span><span class="o">.</span><span class="na">getTag</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">layoutId</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ViewHolder</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
            <span class="n">view</span><span class="o">.</span><span class="na">setTag</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">customizeView</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">holder</span><span class="o">,</span> <span class="n">storedItems</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">view</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">customizeView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="n">ViewHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kd">final</span> <span class="n">DocumentInfo</span> <span class="n">documentInfo</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">deviceName</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">documentInfo</span><span class="o">.</span><span class="na">getFields</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getDeviceNameField</span><span class="o">());</span>
        <span class="n">String</span> <span class="n">devicePlatform</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">documentInfo</span><span class="o">.</span><span class="na">getFields</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getPlatformField</span><span class="o">());</span>
        <span class="n">Double</span> <span class="n">devicePrice</span> <span class="o">=</span> <span class="o">(</span><span class="n">Double</span><span class="o">)</span> <span class="n">documentInfo</span><span class="o">.</span><span class="na">getFields</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getDevicePriceField</span><span class="o">());</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">tvStoredItemName</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">deviceName</span><span class="o">);</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">tvStoredItemStatus</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">devicePlatform</span><span class="o">);</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">tvStoredItemPrice</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">devicePrice</span><span class="o">));</span>
        <span class="n">view</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ItemDetailsActivity</span><span class="o">.</span><span class="na">display</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">documentInfo</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ViewHolder</span> <span class="o">{</span>
        <span class="nd">@BindView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tvStoredItemName</span><span class="o">)</span> <span class="n">TextView</span> <span class="n">tvStoredItemName</span><span class="o">;</span>
        <span class="nd">@BindView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tvStoredItemPlatform</span><span class="o">)</span> <span class="n">TextView</span> <span class="n">tvStoredItemStatus</span><span class="o">;</span>
        <span class="nd">@BindView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tvStoredItemPrice</span><span class="o">)</span> <span class="n">TextView</span> <span class="n">tvStoredItemPrice</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">ViewHolder</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ButterKnife</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">view</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>В качестве элемента списка используем следующий layout-файл:</p>
<div class="codehilite"><pre><span></span> <span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;RelativeLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
    <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/tvStoredItemName&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:layout_alignParentLeft=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:layout_toLeftOf=</span><span class="s">&quot;@+id/tvStoredItemPlatform&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/storedItemName&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/tvStoredItemPlatform&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:layout_marginRight=</span><span class="s">&quot;32dp&quot;</span>
        <span class="na">android:layout_toLeftOf=</span><span class="s">&quot;@+id/tvStoredItemPrice&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/storedItemStatus&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/tvStoredItemPrice&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:layout_alignParentRight=</span><span class="s">&quot;true&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/storedItemPrice&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/RelativeLayout&gt;</span>
</pre></div>


<p>Данные о товарах, хранящихся в БД мы будем получать в методе <code>onResume()</code> активности <code>MainActivity</code>. Для этого в метод <code>onResume</code> добавим следующий код:</p>
<div class="codehilite"><pre><span></span><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span>
    <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">(</span><span class="n">COLLECTION_NAME</span><span class="o">);</span>
    <span class="n">query</span><span class="o">.</span><span class="na">findDocuments</span><span class="o">(</span><span class="k">new</span> <span class="n">CallbackFindDocument</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentFound</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">DocumentInfo</span><span class="o">&gt;</span> <span class="n">documentInfos</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">documentInfos</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">setAdapter</span><span class="o">(</span><span class="n">documentInfos</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentNotFound</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">getResources</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_get_docs</span><span class="o">),</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>


<p>В данном коде мы создаем экземпляр объекта <code>Query</code> не задавая параметров (т.е выбираем первые 100 документов из данной коллекции) и далее с помощью метода findDocument получаем документы из нашей коллекции.</p>
<p>В случае если удалось найти документы мы устанавливаем адаптер, иначе выдаем сообщение об ошибке.</p>
<p>Так же добавим необходимые иконки в <code>ActionBar</code> активности. Для этого создадим <code>layout</code> файл <code>main_activity_menu</code> и добавим туда следующий xml код:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;menu</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:app=</span><span class="s">&quot;http://schemas.android.com/apk/res-auto&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_add_item&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/ic_create_new_folder_white_24dp&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_add_item&quot;</span>
        <span class="na">app:showAsAction=</span><span class="s">&quot;always&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_set_filter&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/ic_filter_list_white_24dp&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_filter_item&quot;</span>
        <span class="na">app:showAsAction=</span><span class="s">&quot;ifRoom&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_logout&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/ic_exit_to_app_white_24dp&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_logout_item&quot;</span>
        <span class="na">app:showAsAction=</span><span class="s">&quot;ifRoom&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/menu&gt;</span>
</pre></div>


<p>Т.е в <code>ActionBar</code> мы будем отображать иконки «Добавить элемент в БД», «Установить фильтр» и «Завершить активную сессию пользователя» (logout). На экран активности данные иконки добавим при помощи следующего метода:</p>
<div class="codehilite"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onCreateOptionsMenu</span><span class="o">(</span><span class="n">Menu</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getMenuInflater</span><span class="o">().</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">menu</span><span class="o">.</span><span class="na">main_activity_menu</span><span class="o">,</span> <span class="n">menu</span><span class="o">);</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onCreateOptionsMenu</span><span class="o">(</span><span class="n">menu</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p>Обрабатывать нажатия на иконки будем при помощи метода показанного ниже</p>
<div class="codehilite"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onOptionsItemSelected</span><span class="o">(</span><span class="n">MenuItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getItemId</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_add_item</span><span class="o">:</span>
            <span class="n">AddItemActivity</span><span class="o">.</span><span class="na">display</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_set_filter</span><span class="o">:</span>
            <span class="k">new</span> <span class="n">FilterDialog</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">showFilterDialog</span><span class="o">(</span><span class="k">new</span> <span class="n">FilterDialog</span><span class="o">.</span><span class="na">CallbackFilterDialog</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFilterApplied</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">DocumentInfo</span><span class="o">&gt;</span> <span class="n">documentInfo</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">setAdapter</span><span class="o">(</span><span class="n">documentInfo</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="k">break</span><span class="o">;</span>

        <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_logout</span><span class="o">:</span>
            <span class="n">LoginActivity</span><span class="o">.</span><span class="na">logout</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onOptionsItemSelected</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p>Готовый экран данной активности показан на рисунке 2.1</p>
<p><img alt="главный экран приложения" src="../img/Storehouse/2.1.png" /></p>
<p>Рисунок 2.1 — главный экран приложения.</p>
<p>На данном экране показаны текущие модели телефонов, присутствующие на складе. В верхнем правом углу экрана показаны следующие иконки:</p>
<p><img alt="Добавить новую модель в базу данных" src="../img/Storehouse/2.1.1.png" /> - Добавить новую модель в базу данных.</p>
<p><img alt="Применить фильтр к списку устройств" src="../img/Storehouse/2.1.2.png" /> - Применить фильтр к списку устройств.</p>
<p><img alt="Закончить активную сессию пользователя" src="../img/Storehouse/2.1.3.png" /> - Закончить активную сессию пользователя (logout).  </p>
<p>При нажатии на кнопку <img alt="Добавить новую модель в базу данных" src="../img/Storehouse/2.1.1.png" />  пользователь переходит на экран добавления устройства в БД.</p>
<h2 id="_6">Экран добавления устройства<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>Создадим активность с именем <code>AddItemActivity</code> и добавим в её layout-файл следующий xml код:</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/activity_add_item&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;prof_itgroup.ru.storehouseapp.Activities.AddItemActivity&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ScrollView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;include</span> <span class="na">layout=</span><span class="s">&quot;@layout/item_core&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/ScrollView&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>


<p>В свою очередь, включаемый файл item_core.xml представляет собой:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;LinearLayout</span> <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/add_item_device_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/etDeviceName&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:hint=</span><span class="s">&quot;@string/add_item_hint_device_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/add_item_device_platform&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/etDevicePlatform&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:hint=</span><span class="s">&quot;@string/add_item_hint_device_platform&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/add_item_camera_info&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/etDeviceCameraInfo&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:hint=</span><span class="s">&quot;@string/add_item_hint_camera_info&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/add_item_available_colors_info&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/etDeviceColors&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:hint=</span><span class="s">&quot;@string/add_item_hint_available_colors_info&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/llChangeColorList&quot;</span>
        <span class="na">android:visibility=</span><span class="s">&quot;gone&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
        <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Button</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/btnAddColor&quot;</span>
            <span class="na">android:padding=</span><span class="s">&quot;12dp&quot;</span>
            <span class="na">android:layout_marginRight=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/add_color&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Button</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/btnRemoveColor&quot;</span>
            <span class="na">android:padding=</span><span class="s">&quot;12dp&quot;</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/remove_color&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/add_item_price&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/etDevicePrice&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/textStyle&quot;</span>
        <span class="na">android:inputType=</span><span class="s">&quot;number&quot;</span>
        <span class="na">android:hint=</span><span class="s">&quot;@string/add_item_hint_available_amount_info&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/llChangePrice&quot;</span>
        <span class="na">android:visibility=</span><span class="s">&quot;gone&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
        <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Button</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/btnIncreaseCount&quot;</span>
            <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:layout_marginRight=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/increase_item_count&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Button</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/btnDecreaseCount&quot;</span>
            <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/decrease_item_count&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>
    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
        <span class="na">android:gravity=</span><span class="s">&quot;center&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;200dp&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:weightSum=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Button</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/btnAddItem&quot;</span>
            <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:background=</span><span class="s">&quot;#64b5f6&quot;</span>
            <span class="na">android:textColor=</span><span class="s">&quot;@android:color/white&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/add&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Button</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/btnClear&quot;</span>
            <span class="na">android:padding=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:background=</span><span class="s">&quot;#64b5f6&quot;</span>
            <span class="na">android:textColor=</span><span class="s">&quot;@android:color/white&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/button_clear&quot;</span>
            <span class="na">android:layout_weight=</span><span class="s">&quot;0.22&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>


<p>Итоговый вид активности показан на рисунке 2.2</p>
<p><img alt="Экран добавления нового устройства в БД" src="../img/Storehouse/2.2.png" /></p>
<p>Рисунок 2.2 — Экран добавления нового устройства в БД.</p>
<p>На этом экране пользователь вводит всю необходиму информацию о устройстве и нажимает кнопку «ДОБАВИТЬ». При этом программа создает новый документ, заполняет его поля и сохраняет на сервере.  Добавим данные действия: зададим обработчик нажатия кнопки «Добавить» который будет вызывать метод показанный ниже:</p>
<div class="codehilite"><pre><span></span><span class="nd">@OnClick</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btnAddItem</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBtnAddItemClicked</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Document</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">COLLECTION_NAME</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isAllFieldsFilled</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">document</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getDeviceNameField</span><span class="o">(),</span> <span class="n">getStringFrom</span><span class="o">(</span><span class="n">etDeviceName</span><span class="o">).</span><span class="na">trim</span><span class="o">());</span>
        <span class="n">document</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getPlatformField</span><span class="o">(),</span> <span class="n">getStringFrom</span><span class="o">(</span><span class="n">etDevicePlatform</span><span class="o">).</span><span class="na">trim</span><span class="o">());</span>
        <span class="n">document</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getCameraInfoField</span><span class="o">(),</span> <span class="n">getStringFrom</span><span class="o">(</span><span class="n">etDeviceCameraInfo</span><span class="o">).</span><span class="na">trim</span><span class="o">());</span>
        <span class="n">document</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getColorsAvailableField</span><span class="o">(),</span> <span class="n">getColorsListFrom</span><span class="o">(</span><span class="n">getStringFrom</span><span class="o">(</span><span class="n">etDeviceColors</span><span class="o">)));</span>
        <span class="n">document</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getDevicePriceField</span><span class="o">(),</span> <span class="n">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">getStringFrom</span><span class="o">(</span><span class="n">etDevicePrice</span><span class="o">)));</span>
        <span class="n">document</span><span class="o">.</span><span class="na">saveDocument</span><span class="o">(</span><span class="k">new</span> <span class="n">CallbackDocumentSaved</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentSaved</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">AddItemActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">succed_add_item</span><span class="o">),</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                <span class="n">finish</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentSaveFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">AddItemActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_add_item</span><span class="o">),</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">wrong_data</span><span class="o">),</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>В данном методе мы создаем экземпляр класса <code>Document</code>, проверяем заполнил ли пользователь всю информацию в соответствующих <code>EditText</code> и устанавливаем поля документа при помощи метода <code>setField(…)</code> после чего сохраняем документ. Поскольку документ создан без ассоциации с реальным документом из БД (т.е без использования метода <code>getDocumentById()</code>, то новый документ с указанными полями будет загружен на сервер.</p>
<p>Документы хранятся в БД Scorocode в виде показанном на рисунке 2.3</p>
<p><img alt="храниение документов в коллекции БД Scorocode" src="../img/Storehouse/2.3.png" /></p>
<p>Рисунок 2.3 — храниение документов в коллекции БД Scorocode.</p>
<p>Каждый документ содержит системные и пользовательские поля.
Системными являются:</p>
<ol>
<li>id — уникальный идентификатор документа в коллекции</li>
<li>readACL — права на чтения данного документа.</li>
<li>updateACL — права на обновление данного документа.</li>
<li>removeACL — права на удаление данного документа.</li>
<li>createdAt — время создания документа.</li>
<li>updatedAt - время последнего обновления документа.</li>
</ol>
<p>Пользователь может добавлять другие поля по своему усмотрению используя кнопку «Добавить поле» на верхней панели. Пользователь так же может добавить документ нажав кнопку «Добавить документ» на верхней панели и введя значения полей вручную. Более подробно о функциональности верхней панели БД см.документацию Scorocode.</p>
<p>При нажатии на кнопку <img alt="Применить фильтр к списку устройств" src="../img/Storehouse/2.1.2.png" /> пользователь попадает в диалоговое окно фильтра.</p>
<p>Создадим данное диалоговое окно. Для этого создадим класс <code>FilterDialog</code> код которого показан ниже:</p>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">prof_itgroup.ru.storehouseapp.Objects</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.DialogInterface</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.support.v7.app.AlertDialog</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.CheckBox</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.EditText</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">butterknife.ButterKnife</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">prof_itgroup.ru.storehouseapp.Activities.MainActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">prof_itgroup.ru.storehouseapp.Helpers.Helper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">prof_itgroup.ru.storehouseapp.R</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">ru.profit_group.scorocode_sdk.Callbacks.CallbackFindDocument</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">ru.profit_group.scorocode_sdk.scorocode_objects.DocumentInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">ru.profit_group.scorocode_sdk.scorocode_objects.Query</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FilterDialog</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Context</span> <span class="n">context</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">FilterDialog</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">showFilterDialog</span><span class="o">(</span><span class="kd">final</span> <span class="n">CallbackFilterDialog</span> <span class="n">callbackFilterDialog</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">View</span> <span class="n">v</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">filter_layout</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">CheckBox</span> <span class="n">cbPriceFilter</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cbPriceFilter</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">CheckBox</span> <span class="n">cbPlatformFilter</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cbPlatformFilter</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">CheckBox</span> <span class="n">cbColourFilter</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cbColorFilter</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">EditText</span> <span class="n">etPlatformFilter</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">etPlatformFilter</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">EditText</span> <span class="n">etColors</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">etColors</span><span class="o">);</span>
        <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">context</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">titleChooseFilterProperties</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setPositiveButton</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">continue_action</span><span class="o">,</span> <span class="k">new</span> <span class="n">DialogInterface</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">DialogInterface</span> <span class="n">dialog</span><span class="o">,</span> <span class="kt">int</span> <span class="n">which</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">COLLECTION_NAME</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">cbPriceFilter</span><span class="o">.</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">setPriceFilter</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">query</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">cbPlatformFilter</span><span class="o">.</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">query</span><span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="k">new</span> <span class="n">DocumentFields</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">getPlatformField</span><span class="o">(),</span> <span class="n">etPlatformFilter</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
                        <span class="o">}</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">cbColourFilter</span><span class="o">.</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">colors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
                            <span class="n">colors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">Helper</span><span class="o">.</span><span class="na">getStringFrom</span><span class="o">(</span><span class="n">etColors</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)));</span>
                            <span class="n">query</span><span class="o">.</span><span class="na">containedIn</span><span class="o">(</span><span class="k">new</span> <span class="n">DocumentFields</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">getColorsAvailableField</span><span class="o">(),</span> <span class="n">colors</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="n">query</span><span class="o">.</span><span class="na">findDocuments</span><span class="o">(</span><span class="k">new</span> <span class="n">CallbackFindDocument</span><span class="o">()</span> <span class="o">{</span>
                            <span class="nd">@Override</span>
                            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentFound</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">DocumentInfo</span><span class="o">&gt;</span> <span class="n">documentInfos</span><span class="o">)</span> <span class="o">{</span>
                                 <span class="n">callbackFilterDialog</span><span class="o">.</span><span class="na">onFilterApplied</span><span class="o">(</span><span class="n">documentInfos</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="nd">@Override</span>
                            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentNotFound</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">});</span>
                    <span class="o">}</span>
                <span class="o">}).</span><span class="na">setView</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setPriceFilter</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="n">Query</span> <span class="n">query</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">priceField</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DocumentFields</span><span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">getContext</span><span class="o">()).</span><span class="na">getDevicePriceField</span><span class="o">();</span>
        <span class="kd">final</span> <span class="n">CheckBox</span> <span class="n">cbIncludeLower</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cbIncludeLower</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">CheckBox</span> <span class="n">cbIncludeUpper</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cbIncludeUpper</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">EditText</span> <span class="n">etLowerPrice</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">etPriceFrom</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">EditText</span> <span class="n">etUpperPrice</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">etPriceTo</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">cbIncludeLower</span><span class="o">.</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">query</span><span class="o">.</span><span class="na">greaterThenOrEqualTo</span><span class="o">(</span><span class="n">priceField</span><span class="o">,</span> <span class="n">getPrice</span><span class="o">(</span><span class="n">etLowerPrice</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">query</span><span class="o">.</span><span class="na">greaterThan</span><span class="o">(</span><span class="n">priceField</span><span class="o">,</span> <span class="n">getPrice</span><span class="o">(</span><span class="n">etLowerPrice</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">cbIncludeUpper</span><span class="o">.</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">query</span><span class="o">.</span><span class="na">lessThanOrEqualTo</span><span class="o">(</span><span class="n">priceField</span><span class="o">,</span> <span class="n">getPrice</span><span class="o">(</span><span class="n">etUpperPrice</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">query</span><span class="o">.</span><span class="na">lessThan</span><span class="o">(</span><span class="n">priceField</span><span class="o">,</span> <span class="n">getPrice</span><span class="o">(</span><span class="n">etUpperPrice</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="n">Double</span> <span class="nf">getPrice</span><span class="o">(</span><span class="n">EditText</span> <span class="n">etPrice</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">price</span> <span class="o">=</span> <span class="n">etPrice</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">Double</span> <span class="n">priceDouble</span> <span class="o">=</span> <span class="mf">0d</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">price</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">priceDouble</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">price</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">priceDouble</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CallbackFilterDialog</span> <span class="o">{</span>
        <span class="kt">void</span> <span class="nf">onFilterApplied</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">DocumentInfo</span><span class="o">&gt;</span> <span class="n">documentInfo</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>В методе <code>showFilterDialog</code> мы создаем <code>AlertDialog</code> и задаем ему <code>View</code> из следующего layout-файла:</p>
<div class="codehilite"><pre><span></span> <span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">android:padding=</span><span class="s">&quot;16dp&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;include</span> <span class="na">layout=</span><span class="s">&quot;@layout/price_filter_layout&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;include</span> <span class="na">layout=</span><span class="s">&quot;@layout/dilimeter&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;include</span> <span class="na">layout=</span><span class="s">&quot;@layout/platform_filter&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;include</span> <span class="na">layout=</span><span class="s">&quot;@layout/dilimeter&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;CheckBox</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/cbColorFilter&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/colorsFilter&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;EditText</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/etColors&quot;</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;16dp&quot;</span>
            <span class="na">android:hint=</span><span class="s">&quot;@string/color_filter_hint&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>


<p>Включаемые layout-файлы <code>price_filter_layout</code> и <code>platform_filter</code> показаны ниже:</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">tools:showIn=</span><span class="s">&quot;@layout/filter_layout&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;CheckBox</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/cbPriceFilter&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:layout_marginStart=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/filter_price_from&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;EditText</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/etPriceFrom&quot;</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;4dp&quot;</span>
            <span class="na">android:layout_marginStart=</span><span class="s">&quot;4dp&quot;</span>
            <span class="na">android:minWidth=</span><span class="s">&quot;60dp&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/filter_price_up_to&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;EditText</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/etPriceTo&quot;</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;4dp&quot;</span>
            <span class="na">android:layout_marginStart=</span><span class="s">&quot;4dp&quot;</span>
            <span class="na">android:minWidth=</span><span class="s">&quot;60dp&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>
    <span class="nt">&lt;RelativeLayout</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;LinearLayout</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/llLowerBound&quot;</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;32dp&quot;</span>
            <span class="na">android:layout_alignParentLeft=</span><span class="s">&quot;true&quot;</span>
            <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;CheckBox</span>
                <span class="na">android:id=</span><span class="s">&quot;@+id/cbIncludeLower&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;TextView</span>
                <span class="na">android:layout_gravity=</span><span class="s">&quot;fill&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;@string/include_lower&quot;</span>
                <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/LinearLayout&gt;</span>
        <span class="nt">&lt;LinearLayout</span>
            <span class="na">android:layout_marginLeft=</span><span class="s">&quot;160dp&quot;</span>
            <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;CheckBox</span>
                <span class="na">android:id=</span><span class="s">&quot;@+id/cbIncludeUpper&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;TextView</span>
                <span class="na">android:layout_gravity=</span><span class="s">&quot;fill&quot;</span>
                <span class="na">android:text=</span><span class="s">&quot;@string/include_upper&quot;</span>
                <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/LinearLayout&gt;</span>
    <span class="nt">&lt;/RelativeLayout&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;horizontal&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
    <span class="na">tools:showIn=</span><span class="s">&quot;@layout/filter_layout&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;CheckBox</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/cbPlatformFilter&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;TextView</span>
        <span class="na">android:layout_marginLeft=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:layout_marginStart=</span><span class="s">&quot;8dp&quot;</span>
        <span class="na">android:text=</span><span class="s">&quot;@string/filter_platform&quot;</span>
        <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/etPlatformFilter&quot;</span>
        <span class="na">android:layout_marginLeft=</span><span class="s">&quot;4dp&quot;</span>
        <span class="na">android:layout_marginStart=</span><span class="s">&quot;4dp&quot;</span>
        <span class="na">android:minWidth=</span><span class="s">&quot;60dp&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>


<p>Диалоговое окно фильтра показано на рисунке 2.4</p>
<p><img alt="Диалоговое окно фильтра" src="../img/Storehouse/2.4.png" /></p>
<p>Рисунок 2.4 — диалоговое окно фильтра.</p>
<p>В данном диалоговом окне пользователь может задать условия выборки из БД по определенным критериям, а именно:
<em> Цена устройства
</em> Платформа устройства (Android или iOS, а так же номер версии ОС).
* Доступные в наличии цвета.</p>
<p>При нажатии на кнопку «Продолжить» мы проверяем выбраны ли элементы CheckBox и если да — ставим соответствующий фильтр.</p>
<p>Листинг кода для задания фильтра:  </p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">showFilterDialog</span><span class="o">(</span><span class="kd">final</span> <span class="n">CallbackFilterDialog</span> <span class="n">callbackFilterDialog</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">View</span> <span class="n">v</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">filter_layout</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">CheckBox</span> <span class="n">cbPriceFilter</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cbPriceFilter</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">CheckBox</span> <span class="n">cbPlatformFilter</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cbPlatformFilter</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">CheckBox</span> <span class="n">cbColourFilter</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cbColorFilter</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">EditText</span> <span class="n">etPlatformFilter</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">etPlatformFilter</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">EditText</span> <span class="n">etColors</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">etColors</span><span class="o">);</span>

    <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlertDialog</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">context</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">titleChooseFilterProperties</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setPositiveButton</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">continue_action</span><span class="o">,</span> <span class="k">new</span> <span class="n">DialogInterface</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">DialogInterface</span> <span class="n">dialog</span><span class="o">,</span> <span class="kt">int</span> <span class="n">which</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">COLLECTION_NAME</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">cbPriceFilter</span><span class="o">.</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">setPriceFilter</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">query</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">cbPlatformFilter</span><span class="o">.</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">query</span><span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="k">new</span> <span class="n">DocumentFields</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">getPlatformField</span><span class="o">(),</span> <span class="n">etPlatformFilter</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
                    <span class="o">}</span>

                    <span class="k">if</span><span class="o">(</span><span class="n">cbColourFilter</span><span class="o">.</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">colors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
                        <span class="n">colors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">Helper</span><span class="o">.</span><span class="na">getStringFrom</span><span class="o">(</span><span class="n">etColors</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)));</span>
                        <span class="n">query</span><span class="o">.</span><span class="na">containedIn</span><span class="o">(</span><span class="k">new</span> <span class="n">DocumentFields</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">getColorsAvailableField</span><span class="o">(),</span> <span class="n">colors</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">query</span><span class="o">.</span><span class="na">findDocuments</span><span class="o">(</span><span class="k">new</span> <span class="n">CallbackFindDocument</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentFound</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">DocumentInfo</span><span class="o">&gt;</span> <span class="n">documentInfos</span><span class="o">)</span> <span class="o">{</span>
                             <span class="n">callbackFilterDialog</span><span class="o">.</span><span class="na">onFilterApplied</span><span class="o">(</span><span class="n">documentInfos</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentNotFound</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                <span class="o">}</span>
            <span class="o">}).</span><span class="na">setView</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">setPriceFilter</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="n">Query</span> <span class="n">query</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">priceField</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DocumentFields</span><span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">getContext</span><span class="o">()).</span><span class="na">getDevicePriceField</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">CheckBox</span> <span class="n">cbIncludeLower</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cbIncludeLower</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">CheckBox</span> <span class="n">cbIncludeUpper</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">cbIncludeUpper</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">EditText</span> <span class="n">etLowerPrice</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">etPriceFrom</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">EditText</span> <span class="n">etUpperPrice</span> <span class="o">=</span> <span class="n">ButterKnife</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">etPriceTo</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">cbIncludeLower</span><span class="o">.</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">query</span><span class="o">.</span><span class="na">greaterThenOrEqualTo</span><span class="o">(</span><span class="n">priceField</span><span class="o">,</span> <span class="n">getPrice</span><span class="o">(</span><span class="n">etLowerPrice</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">query</span><span class="o">.</span><span class="na">greaterThan</span><span class="o">(</span><span class="n">priceField</span><span class="o">,</span> <span class="n">getPrice</span><span class="o">(</span><span class="n">etLowerPrice</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">if</span><span class="o">(</span><span class="n">cbIncludeUpper</span><span class="o">.</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">query</span><span class="o">.</span><span class="na">lessThanOrEqualTo</span><span class="o">(</span><span class="n">priceField</span><span class="o">,</span> <span class="n">getPrice</span><span class="o">(</span><span class="n">etUpperPrice</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">query</span><span class="o">.</span><span class="na">lessThan</span><span class="o">(</span><span class="n">priceField</span><span class="o">,</span> <span class="n">getPrice</span><span class="o">(</span><span class="n">etUpperPrice</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Фильтр задается следующим образом: мы создаем объект <code>Query</code>, выборку мы ведем из нашей коллекции. Далее: если выбран фильтр цены (установлена соответствующая галочка), то мы выбираем из БД только устройства для которых цена попадает в пределы указанных границ.</p>
<p>Границы цен задаются при помощи следующих методов:
<em> greaterThan задает нижнюю границу цены (не включая указанную цену).
</em> lessThan задает верхнюю границу цены (не включая указанную цену).
<em> greaterThanOrEqualTo задает нижнюю границу цены включая указанную цену.
</em> lessThanOrEqualTo задает верхнюю границу цены включая указанную цену.</p>
<p>Поиск по платформе задается при помощи метода <code>equalTo(field, value)</code> класса <code>Query</code> который указывает экземпляру данного класса оставить в выборке только документы у которых значение поля указанного в параметре <code>field</code> совпадает с <code>value</code>. В нашем случае мы можем например найти все Android 7.0 девайсы, указав <code>query.equalTo(«platform», «Android 7.0»);</code></p>
<p>Поиск по доступным цветам задается при помощи метода <code>containedIn</code> класса <code>Query</code> который оставляет в выборке только те документы для которых поле (типа массив) содержит все элементы заданного массива.</p>
<p>Таким образом мы формируем запрос (query) для указанной коллекции БД и получаем экземпляры класса <code>DocumentInfo</code> характеризующие документы, удовлетворяющие данному запросу. Эту информацию мы передаем в активность при помощи callback и обновляем информацию.</p>
<p>При нажатии на кнопку <img alt="Закончить активную сессию пользователя" src="../img/Storehouse/2.1.3.png" /> происходит завершение активной сессии пользователя (logout) и пользователь попадает обратно на стартовый экран приложения.</p>
<p>Для осуществления данной функциональности нужно задать обработчик нажатия для данной кнопки, вызывающий метод  <code>logout</code> класса <code>User</code> для завершения активной сессии пользователя:</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">logout</span><span class="o">(</span><span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">LocalPersistence</span><span class="o">.</span><span class="na">writeObjectToFile</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">LocalPersistence</span><span class="o">.</span><span class="na">FILE_USER_INFO</span><span class="o">);</span>
    <span class="k">new</span> <span class="n">User</span><span class="o">().</span><span class="na">logout</span><span class="o">(</span><span class="k">new</span> <span class="n">CallbackLogoutUser</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLogoutSucceed</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">display</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLogoutFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>


<p>В данном методе сначала удаляется файл с информацией о пользователе (данный файл хранится локально и используется для проверки того факта, что пользователь прошел идентификацию в приложении) затем используется метод <code>logout(…)</code> класса <code>User</code>, который завершает активную сессию пользователя.</p>
<p>В случае успешного завершения активной сессии пользователя будет вызван метод <code>onLogoutSucceed(...) callback</code> интерфейса, иначе будет вызван метод <code>onLogoutFailed(...)</code>.</p>
<h2 id="_7">Экран подробной информации о устройстве.<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>При нажатии на любой из элементов списка устройств главного экрана приложения пользователь попадает на экран подробной информации об устройстве.</p>
<p>Создадим активность с именем <code>ItemDetailsInfo</code> и в layout-файл данной активности добавим следующий xml код:</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/activity_detailed_item_info&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:padding=</span><span class="s">&quot;16dp&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;prof_itgroup.ru.storehouseapp.Activities.ItemDetailsActivity&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ScrollView</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;include</span> <span class="na">layout=</span><span class="s">&quot;@layout/item_core&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/ScrollView&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>


<p>Как видно layout-файл активности переиспользует xml код экрана добавления элемента в БД, но на данном экране так же присутствует возможность перейти в режим редактирования, т.е актививровать скрытые <code>View</code> экрана.</p>
<p>В <code>ActionBar</code> данного экрана так же добавим иконки для редактирования записи об устройстве (документа), удаления записи об устройстве (документа) и перехода на экран информации об отгрузке.</p>
<p>Для задания иконок в <code>ActionBar</code> создадим layout-файл с именем <code>detailed_info_menu</code> и добавим в него следующий код:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;menu</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:app=</span><span class="s">&quot;http://schemas.android.com/apk/res-auto&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_edit_item&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_edit_item&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/ic_mode_edit_white_24dp&quot;</span>
        <span class="na">app:showAsAction=</span><span class="s">&quot;always&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_remove_item&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_remove_item&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/ic_delete_forever_white_24dp&quot;</span>
        <span class="na">app:showAsAction=</span><span class="s">&quot;ifRoom&quot;</span><span class="nt">/&gt;</span>

     <span class="nt">&lt;item</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/action_prepare_item&quot;</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/ic_assignment_white_24dp&quot;</span>
        <span class="na">android:title=</span><span class="s">&quot;@string/action_prepare_item&quot;</span>
        <span class="na">app:showAsAction=</span><span class="s">&quot;ifRoom&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/menu&gt;</span>
</pre></div>


<p>В самой активности добавим метод:</p>
<div class="codehilite"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onCreateOptionsMenu</span><span class="o">(</span><span class="n">Menu</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getMenuInflater</span><span class="o">().</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">menu</span><span class="o">.</span><span class="na">detailed_info_menu</span><span class="o">,</span> <span class="n">menu</span><span class="o">);</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onCreateOptionsMenu</span><span class="o">(</span><span class="n">menu</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p>который установит иконки в <code>ActionBar</code>.</p>
<p>Обрабатывать нажатие на иконки мы будем при помощи метода указанного ниже:</p>
<div class="codehilite"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onOptionsItemSelected</span><span class="o">(</span><span class="n">MenuItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getItemId</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">home</span><span class="o">:</span>
            <span class="n">finish</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_edit_item</span><span class="o">:</span>
            <span class="n">setEditMode</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_remove_item</span><span class="o">:</span>
            <span class="n">DocumentHelper</span><span class="o">.</span><span class="na">fetchAndRemoveDocument</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">document</span><span class="o">,</span> <span class="n">getDocumentInfo</span><span class="o">());</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_prepare_item</span><span class="o">:</span>
            <span class="n">SendItemActivity</span><span class="o">.</span><span class="na">display</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">getDocumentInfo</span><span class="o">());</span>
            <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onOptionsItemSelected</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p>В результате получим экран показанный на рисунке 3.1</p>
<p><img alt="экран подробной информации об устройстве" src="../img/Storehouse/3.1.png" /></p>
<p>Рисунок 3.1 — экран подробной информации об устройстве.</p>
<p>В верхней правой части экрана присутствуют следующие иконки:</p>
<p><img alt="Редактировать информацию о устройстве" src="../img/Storehouse/3.1.1.png" /> Редактировать информацию о устройстве</p>
<p><img alt="Удалить данное устройство из БД" src="../img/Storehouse/3.1.2.png" /> Удалить данное устройство из БД</p>
<p><img alt="Перейти к информации об отгрузке данного товара." src="../img/Storehouse/3.1.3.png" /> Перейти к информации об отгрузке данного товара.</p>
<p>При нажатии на кнопку <img alt="Редактировать информацию о устройстве" src="../img/Storehouse/3.1.1.png" /> экран переключается в режим редактирования. Для этого сделаем видимыми кнопки «Добавить цвет», «Удалить цвет», «Увеличить цену на складе», «Уменьшить цену на складе». Экран подробной информации о устройстве в режиме редактирования показан на рисунке 3.2</p>
<p><img alt="Экран подробной информации об устройстве в режиме редактирования" src="../img/Storehouse/3.2.png" /></p>
<p>Рисунок 3.2 — Экран подробной информации об устройстве в режиме редактирования</p>
<p>Зададим обработчик нажатия кнопки «Изменить запись», который будет вызывать следующий метод:</p>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateItemDocument</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">document</span><span class="o">.</span><span class="na">getDocumentById</span><span class="o">(</span><span class="n">getDocumentInfo</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="k">new</span> <span class="n">CallbackGetDocumentById</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentFound</span><span class="o">(</span><span class="n">DocumentInfo</span> <span class="n">documentInfo</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">document</span><span class="o">.</span><span class="na">updateDocument</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getDeviceNameField</span><span class="o">(),</span> <span class="n">getStringFrom</span><span class="o">(</span><span class="n">etDeviceName</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getPlatformField</span><span class="o">(),</span> <span class="n">getStringFrom</span><span class="o">(</span><span class="n">etDevicePlatform</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getCameraInfoField</span><span class="o">(),</span> <span class="n">getStringFrom</span><span class="o">(</span><span class="n">etDeviceCameraInfo</span><span class="o">));</span>
            <span class="n">setColorsUpdateInfo</span><span class="o">();</span>
            <span class="n">document</span><span class="o">.</span><span class="na">updateDocument</span><span class="o">().</span><span class="na">inc</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getDevicePriceField</span><span class="o">(),</span> <span class="n">increaseCount</span><span class="o">);</span>
            <span class="n">document</span><span class="o">.</span><span class="na">saveDocument</span><span class="o">(</span><span class="k">new</span> <span class="n">CallbackDocumentSaved</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentSaved</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">setEditMode</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">color</span> <span class="o">:</span> <span class="n">deviceColors</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">deviceColors</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">color</span><span class="o">,</span> <span class="n">ColorState</span><span class="o">.</span><span class="na">FROM_DB</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">document</span><span class="o">.</span><span class="na">updateDocument</span><span class="o">().</span><span class="na">getUpdateInfo</span><span class="o">().</span><span class="na">clear</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentSaveFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">showToast</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_update_item</span><span class="o">);</span>
                    <span class="n">setFields</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentNotFound</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">showToast</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_update_item</span><span class="o">);</span>
            <span class="n">setFields</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">setColorsUpdateInfo</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">color</span> <span class="o">:</span> <span class="n">deviceColors</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">ColorState</span> <span class="n">colorState</span> <span class="o">=</span> <span class="n">deviceColors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">colorState</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">TO_REMOVE</span><span class="o">:</span>
                <span class="n">document</span><span class="o">.</span><span class="na">updateDocument</span><span class="o">().</span><span class="na">pull</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getColorsAvailableField</span><span class="o">(),</span> <span class="n">color</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>

            <span class="k">case</span> <span class="n">NEW</span><span class="o">:</span>
                <span class="n">document</span><span class="o">.</span><span class="na">updateDocument</span><span class="o">().</span><span class="na">push</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getColorsAvailableField</span><span class="o">(),</span> <span class="n">color</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Для обновления информации об устройстве используется метод <code>updateDocument()</code> класса <code>Document</code>. При этом экземпляр класса Document обновление которого мы проводим должен быть ассоциирован с реальным документом из БД при помощи метода <code>getDocumentById</code>. При этом новые значения следующих полей:</p>
<ul>
<li>Название устройства (поле deviceName в БД)</li>
<li>ОС устройства (поле platform в БД)</li>
<li>Информация о камере (deviceCameraInfo)</li>
</ul>
<p>задаются при помощи метода <code>set(field, value)</code> класса <code>Update</code>.</p>
<p>Поле «цена устройства» (поле devicePrice в БД) задается при помощи метода <code>.inc(field, value)</code> класса <code>Update</code>. При этом если мы увеличиваем цену, то используем в положительные значения параметра value, если уменьшаем, то отрицательную.</p>
<p>Поле «доступные цвета» (поле colorsAvailable в БД) задается при помощи методов <code>.push()</code> (для добавления цвета устройства) и <code>.pull()</code> (для удаления цвета устройства).</p>
<p>Рассмотрим еще раз работу метода <code>updateItemDocument(...)</code>: для обновления полей документа нам нужно удостовериться, что такой документ существует и ассоциировать наш экземпляр класса <code>Document</code> с документом в БД. Для этого мы используем метод <code>.getDocumentById(…)</code> класса <code>Document</code>.
После того как мы ассоциировали наш документ с документом из БД мы получаем объект класса <code>Update</code> при помощи метода <code>.updateDocument()</code>. Далее используя объект класса Update мы задаем название, платформу и информацию о камере устройства при помощи метода <code>.set(…)</code>, добавляем в массив (при помощи метода <code>.push()</code>) или удаляем из массива (при помощи метода <code>.pull</code>) доступные цвета для данного устройства и изменяем цену (при помощи метода <code>.inc()</code>) в поле цены. После задания всех необходимых изменений в экземпляре класса <code>Update</code> мы производим сохранение документа при помощи метода <code>.saveDocument(…)</code> класса <code>Document</code>.</p>
<p>Поскольку документ получен путем ассоциации с документом из БД (при помощи метода <code>.getDocumentById</code>), то в результате выполнения <code>.saveDocument(…)</code> произойдет обновление документа, а не создание нового документа.</p>
<p>Рассмотрим действие кнопки <img alt="Удалить данное устройство из БД" src="../img/Storehouse/3.1.2.png" /> - при нажатии на данную кнопку происходит удаление информации об устройстве из БД. Для этого добавим обработчик нажатия данной кнопки вызывающий метод показанный ниже:</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">fetchAndRemoveDocument</span><span class="o">(</span><span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Document</span> <span class="n">document</span><span class="o">,</span> <span class="n">DocumentInfo</span> <span class="n">documentInfo</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">document</span><span class="o">.</span><span class="na">getDocumentById</span><span class="o">(</span><span class="n">documentInfo</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="k">new</span> <span class="n">CallbackGetDocumentById</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentFound</span><span class="o">(</span><span class="n">DocumentInfo</span> <span class="n">documentInfo</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">removeDocument</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">document</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentNotFound</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_document_not_removed</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">removeDocument</span><span class="o">(</span><span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Document</span> <span class="n">document</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">document</span><span class="o">.</span><span class="na">removeDocument</span><span class="o">(</span><span class="k">new</span> <span class="n">CallbackRemoveDocument</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRemoveSucceed</span><span class="o">(</span><span class="n">ResponseRemove</span> <span class="n">responseRemove</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">document_removed</span><span class="o">),</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
                <span class="o">((</span><span class="n">Activity</span><span class="o">)</span> <span class="n">context</span><span class="o">).</span><span class="na">finish</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRemoveFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error_document_not_removed</span><span class="o">),</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
<span class="o">}</span>
</pre></div>


<p>Рассмотрим данный метод подробней:
Сначала мы используем метод <code>.getDocumentById(...)</code> класса <code>Document</code> для того чтобы удостовериться, что такой документ существует и провести ассоциацию данного документа с созданным нами экземпляром класса <code>Document</code>.</p>
<p>После того как мы удостоверились в наличии данного документа мы вызываем метод <code>.removeDocument()</code> класса <code>Document</code> который удаляет документ из БД.</p>
<p>Рассмотрим действие кнопки <img alt="Перейти к информации об отгрузке данного товара." src="../img/Storehouse/3.1.3.png" />. При нажатии на эту кнопку мы переходим к экрану с информацией об отгрузке товара. </p>
<h2 id="_8">Экран информации об отгрузке товара.<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>Создадим новую активность с именем <code>SendItemActivity</code> и добавим в layout-файл данной активности следующий xml код:</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
    <span class="na">android:id=</span><span class="s">&quot;@+id/activity_send_item&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:padding=</span><span class="s">&quot;16dp&quot;</span>
    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
    <span class="na">tools:context=</span><span class="s">&quot;prof_itgroup.ru.storehouseapp.Activities.SendItemActivity&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:id=</span><span class="s">&quot;@+id/llWaitingUsers&quot;</span>
        <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
            <span class="na">android:textColor=</span><span class="s">&quot;@android:color/black&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/action_waiting_list&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/tvWaitingUsers&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/tvLastChangeLabel&quot;</span>
            <span class="na">android:textColor=</span><span class="s">&quot;@android:color/black&quot;</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/last_change&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;TextView</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/tvLastChange&quot;</span>
            <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;LinearLayout</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/llInfoContainer&quot;</span>
            <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;RelativeLayout</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;TextView</span>
                    <span class="na">android:layout_marginTop=</span><span class="s">&quot;8dp&quot;</span>
                    <span class="na">android:textColor=</span><span class="s">&quot;@android:color/black&quot;</span>
                    <span class="na">android:text=</span><span class="s">&quot;@string/item_info&quot;</span>
                    <span class="na">style=</span><span class="s">&quot;@style/label_style&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;TextView</span>
                    <span class="na">android:id=</span><span class="s">&quot;@+id/tvEdit&quot;</span>
                    <span class="na">android:layout_alignParentRight=</span><span class="s">&quot;true&quot;</span>
                    <span class="na">android:layout_marginTop=</span><span class="s">&quot;10dp&quot;</span>
                    <span class="na">android:text=</span><span class="s">&quot;@string/editInfo&quot;</span>
                    <span class="na">android:textColor=</span><span class="s">&quot;@color/colorPrimary&quot;</span>
                    <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                    <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/RelativeLayout&gt;</span>
            <span class="nt">&lt;ScrollView</span>
                <span class="na">android:layout_marginTop=</span><span class="s">&quot;8dp&quot;</span>
                <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                <span class="na">android:layout_height=</span><span class="s">&quot;180dp&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;EditText</span>
                    <span class="na">android:id=</span><span class="s">&quot;@+id/etItemInfo&quot;</span>
                    <span class="na">android:enabled=</span><span class="s">&quot;false&quot;</span>
                    <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
                    <span class="na">android:layout_height=</span><span class="s">&quot;180dp&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/ScrollView&gt;</span>
        <span class="nt">&lt;/LinearLayout&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>
    <span class="nt">&lt;LinearLayout</span>
        <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
        <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Button</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/btnAppUserInList&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/addUserInList&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;Button</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;8dp&quot;</span>
            <span class="na">android:layout_gravity=</span><span class="s">&quot;center_horizontal&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/btnSendToUser&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;@string/sendToUser&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
            <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/LinearLayout&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>


<p>Полученный экран показан на рисунке  4.1</p>
<p><img alt="экран с информацией об отгрузке товара" src="../img/Storehouse/4.1.png" /></p>
<p>Рисунок 4.1 — экран с информацией об отгрузке товара</p>
<p>При нажатии на кнопку «ДОБАВИТЬ ПОКУПАТЕЛЯ» вызывается диалоговое окно с просьбой ввести информацию о покупателе после чего вызывается метод:</p>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">addBuyerAndRefreshWaitingList</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">buyerInfo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">buyerInfo</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">document</span><span class="o">.</span><span class="na">getDocumentById</span><span class="o">(</span><span class="n">getDocumentInfo</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="k">new</span> <span class="n">CallbackGetDocumentById</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentFound</span><span class="o">(</span><span class="n">DocumentInfo</span> <span class="n">documentInfo</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">document</span><span class="o">.</span><span class="na">updateDocument</span><span class="o">().</span><span class="na">push</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getBuyersField</span><span class="o">(),</span> <span class="n">buyerInfo</span><span class="o">);</span>
                <span class="n">document</span><span class="o">.</span><span class="na">saveDocument</span><span class="o">(</span><span class="k">new</span> <span class="n">CallbackDocumentSaved</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentSaved</span><span class="o">()</span> <span class="o">{</span>
                        <span class="n">document</span><span class="o">.</span><span class="na">updateDocument</span><span class="o">().</span><span class="na">getUpdateInfo</span><span class="o">().</span><span class="na">clear</span><span class="o">();</span>
                        <span class="n">refreshWaitingList</span><span class="o">();</span>
                        <span class="n">showToast</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">add_waiting_buyer</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentSaveFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">showToast</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentNotFound</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">showToast</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Рассмотрим метод более подробно. Сначала проверяем, что введенное поле с именем клиента не является пустым. В случае если пользователь ввел данные происходит ассоциация экземпляра класса Document с документом в БД после чего происходит обновление информации документа следующем образом: веденная пользователем информация о покупателе добавляется в конец массива покупателей с помощью метода <code>.push()</code> класса <code>Update</code>. Таким образом формируется очередь покупателей, ожидающих отправки товара.</p>
<p>При нажатии на кнопку «ОТГРУЗИТЬ ПОЛЬЗОВАТЕЛЮ» из массива ожидающих отправки клиентов должен удаляться первый клиент, должно сохраняться время последней отправки и сотрудники (грузчики, курьеры, бухгалтерия) должны быть оповещены об этом.<br />
Для этого добавим обработчик для данной кнопки, который вызывает метод показанный ниже:</p>
<div class="codehilite"><pre><span></span><span class="nd">@OnClick</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">btnSendToUser</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSendToUserButtonClicked</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">document</span><span class="o">.</span><span class="na">getDocumentById</span><span class="o">(</span><span class="n">getDocumentInfo</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="k">new</span> <span class="n">CallbackGetDocumentById</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentFound</span><span class="o">(</span><span class="kd">final</span> <span class="n">DocumentInfo</span> <span class="n">documentInfo</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">document</span><span class="o">.</span><span class="na">updateDocument</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">popFirst</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getBuyersField</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">setCurrentDate</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getLastSendField</span><span class="o">());</span>

         <span class="n">document</span><span class="o">.</span><span class="na">saveDocument</span><span class="o">(</span><span class="k">new</span> <span class="n">CallbackDocumentSaved</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentSaved</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">document</span><span class="o">.</span><span class="na">updateDocument</span><span class="o">().</span><span class="na">getUpdateInfo</span><span class="o">().</span><span class="na">clear</span><span class="o">();</span>
                    <span class="k">new</span> <span class="n">ItemNotificator</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="n">documentInfo</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">fields</span><span class="o">.</span><span class="na">getDeviceName</span><span class="o">()).</span><span class="na">notifyPersonalAboutItemSend</span><span class="o">();</span>
                    <span class="k">new</span> <span class="n">BalanceNotificator</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">()).</span><span class="na">refreshCompanyBalance</span><span class="o">();</span>
                    <span class="n">etItemInfo</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
                    <span class="n">etItemInfo</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getLastSendTime</span><span class="o">());</span>
                    <span class="n">refreshWaitingList</span><span class="o">();</span>
                <span class="o">}</span>

               <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentSaveFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">showToast</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
 <span class="o">}</span>
</pre></div>


<p>В данном методе происходит ассоциация экземпляра класса <code>Document</code> с документом из БД при помощи метода <code>.getDocumentById()</code> класса <code>Document</code>, после чего получается экземпляр класса <code>Update</code> и используется его метод <code>.popFirst</code> который удаляет первый элемент массива (имитируя обслуживание первого человека в очереди). Кроме того в поле «Последняя отгрузка совершена в» (поле lastSend в БД) записывается время последней отгрузки при помощи метода <code>.setCurrentDate(…)</code> класса <code>Update</code>.</p>
<p>Так же на этом экране присутствует комментарий к отгрузке товара, который хранится в файле документа (поле sendInfo типа File). По умолчанию этот файл отсутствует и в текстовое окно выдается информацию по умолчанию «По товару в настоящее время нет комментария ...». Пользователь может нажать кнопку «редактировать», изменить комментарий к отгрузке и нажать «сохранить». При этом будет вызван метод:</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">uploadFile</span><span class="o">(</span><span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Document</span> <span class="n">document</span><span class="o">,</span> <span class="n">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">document</span><span class="o">.</span><span class="na">uploadFile</span><span class="o">(</span><span class="k">new</span> <span class="n">DocumentFields</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">getSendInfoField</span><span class="o">(),</span> <span class="n">FILE_NAME</span><span class="o">,</span> <span class="n">encode</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()),</span>
        <span class="k">new</span> <span class="n">CallbackUploadFile</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentUploaded</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//file loaded</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentUploadFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>


<p>Данный метод загружает файл в поле (типа File) документа БД. Документ при этом должен быть ассоциирован при помощи метода <code>getDocumentById(…)</code>. Аналогичным образом происходит удаление документа из БД.</p>
<p>Информация о пользователях, ожидающих отгрузки и комментарии загружаются с сервера при помощи метода показанного ниже.</p>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">refreshWaitingList</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">document</span><span class="o">.</span><span class="na">getDocumentById</span><span class="o">(</span><span class="n">getDocumentInfo</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="k">new</span> <span class="n">CallbackGetDocumentById</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentFound</span><span class="o">(</span><span class="n">DocumentInfo</span> <span class="n">documentInfo</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">fields</span><span class="o">.</span><span class="na">setDocumentInfo</span><span class="o">(</span><span class="n">documentInfo</span><span class="o">);</span>
            <span class="n">tvWaitingUsers</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getBuyers</span><span class="o">());</span>
            <span class="n">tvLastChange</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getLastSendTime</span><span class="o">());</span>
            <span class="n">llWaitingUsers</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getBuyers</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="n">View</span><span class="o">.</span><span class="na">GONE</span> <span class="o">:</span> <span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
            <span class="n">tvLastChangeLabel</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getLastSendTime</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="n">View</span><span class="o">.</span><span class="na">GONE</span> <span class="o">:</span> <span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
            <span class="n">tvLastChange</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getLastSendTime</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="n">View</span><span class="o">.</span><span class="na">GONE</span> <span class="o">:</span> <span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
            <span class="n">btnSendToUser</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getBuyers</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="n">View</span><span class="o">.</span><span class="na">GONE</span> <span class="o">:</span> <span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
            <span class="n">document</span><span class="o">.</span><span class="na">getFileContent</span><span class="o">(</span><span class="n">fields</span><span class="o">.</span><span class="na">getSendInfoField</span><span class="o">(),</span> <span class="n">FileHelper</span><span class="o">.</span><span class="na">FILE_NAME</span><span class="o">,</span> <span class="k">new</span> <span class="n">CallbackGetFile</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSucceed</span><span class="o">(</span><span class="n">String</span> <span class="n">fileContent</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">fileContent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fileContent</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">etItemInfo</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">fileContent</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">etItemInfo</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">no_info</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">showToast</span><span class="o">(</span><span class="n">getBaseContext</span><span class="o">(),</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDocumentNotFound</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">tvWaitingUsers</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">GONE</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>


<p>В данном методе происходит ассоциация экземпляра класса <code>Document</code> с документом из БД после чего на экране обновляются значения следующих полей:
1. список ожидающих пользователей
2. время последней отгрузки
3. устанавливается видимость тех или иных элементов в зависимости от контента.
4. При помощи метода getFileContent класса Document получаем содержимое файла в виде строки (с сохранением форматирования). Полученную строку устанавливаем в поле комментария.</p>
<p>Так же создадим класс  ItemNotificator и добавим в него метод notifyPersonalAboutItemSend()
который будем вызывать при отгрузке товара пользователю. Код метода показан ниже
public void notifyPersonalAboutItemSend() {
    sendPushToLoaderPerson();
    sendEmailInAccountingDepartment();
    sendSmsToDeliveryPerson();
}</p>
<p>Данный метод проводит уведомление персонала о том, что товар подготовлен к отправке следующим образом:</p>
<ul>
<li>отсылает push сообщение грузчику при помощи метода:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendPushToLoaderPerson</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">(</span><span class="s">&quot;roles&quot;</span><span class="o">);</span>
    <span class="n">query</span><span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;loaderPerson&quot;</span><span class="o">);</span>
    <span class="n">query</span><span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;isFree&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">query</span><span class="o">.</span><span class="na">setLimit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

    <span class="n">MessagePush</span> <span class="n">messagePush</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessagePush</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">you_should_take</span><span class="o">)</span> <span class="o">+</span> <span class="n">getItemInfo</span><span class="o">()</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">and_prepare</span><span class="o">),</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">message</span><span class="o">.</span><span class="na">sendPush</span><span class="o">(</span><span class="n">messagePush</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="k">new</span> <span class="n">CallbackSendPush</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPushSended</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">push_sended</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPushSendFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">cant_send_push</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>отсылает sms сообщение курьеру</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendSmsToDeliveryPerson</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">(</span><span class="s">&quot;roles&quot;</span><span class="o">);</span>
    <span class="n">query</span><span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;deliveryPerson&quot;</span><span class="o">);</span>
    <span class="n">query</span><span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;isFree&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">query</span><span class="o">.</span><span class="na">setLimit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

    <span class="n">MessageSms</span> <span class="n">messageSms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageSms</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">take_item</span><span class="o">)</span> <span class="o">+</span> <span class="n">getItemInfo</span><span class="o">());</span>
    <span class="n">message</span><span class="o">.</span><span class="na">sendSms</span><span class="o">(</span><span class="n">messageSms</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="k">new</span> <span class="n">CallbackSendSms</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSmsSended</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">sms_was_sended</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSmsSendFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">cant_send_sms</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>отсылает email в бухгалтерию.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendEmailInAccountingDepartment</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">(</span><span class="s">&quot;roles&quot;</span><span class="o">);</span>
    <span class="n">query</span><span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;accountantPerson&quot;</span><span class="o">);</span>

    <span class="n">MessageEmail</span> <span class="n">messageEmail</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageEmail</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">from</span><span class="o">),</span> <span class="n">context</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">device</span><span class="o">)</span> <span class="o">+</span> <span class="n">getItemInfo</span><span class="o">()</span> <span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">device</span><span class="o">)</span> <span class="o">+</span> <span class="n">getItemInfo</span><span class="o">()</span> <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">sold</span><span class="o">));</span>
    <span class="n">message</span><span class="o">.</span><span class="na">sendEmail</span><span class="o">(</span><span class="n">messageEmail</span><span class="o">,</span> <span class="n">query</span><span class="o">,</span> <span class="k">new</span> <span class="n">CallbackSendEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEmailSend</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">email_was_sended</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEmailSendFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">cant_send_email</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>


<p>Рассмотрим работу этих методов более подробно:</p>
<ol>
<li>В методе <code>sendEmailInAccountingDepartment</code> из коллекции ролей («roles») выбирается роль «accountantPerson» и всем пользователям с такой ролью отсылаются email сообщения при помощи метода <code>.sendEmail()</code> класса <code>Message</code>.</li>
<li>В методе <code>sendSmdToDeliveryPerson</code> из коллекции ролей («roles») выбирается один (условие setLimit(1)) свободный (условие isFree == true) сотрудник с ролью «deliveryPerson» и ему отправляется sms при помощи метода <code>.sendSms</code> класса <code>Message</code>.</li>
<li>В методе <code>sendSmdToLoaderPerson</code> из коллекции ролей («roles») выбирается один (условие setLimit(1)) свободный (условие isFree == true) сотрудник с ролью loaderPerson и ему отправляется push при помощи метода <code>.sendPush</code> класса <code>Message</code>.</li>
</ol>
<p>Кроме того после нажатия на кнопку «ОТГРУЗИТЬ ПОЛЬЗОВАТЕЛЮ» вызывается метод <code>refreshCompanyBalance()</code> класса <code>BalanceNotivicator</code>.</p>
<p>Листинг метода <code>resreshCompanyBalance()</code>:</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">refreshCompanyBalance</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Script</span> <span class="n">script</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Script</span><span class="o">();</span>
    <span class="n">script</span><span class="o">.</span><span class="na">runScript</span><span class="o">(</span><span class="s">&quot; 5800ad9342d52f1ba275fbcd&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">CallbackSendScript</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onScriptSended</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">balance_refreshed</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onScriptSendFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Helper</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">can_refresh_balance</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>


<p>В данном листинге при помощи метода <code>runScript(...)</code> класса <code>Script</code> вызывается серверный код с id 5800ad9342d52f1ba275fbcd, который пересчитывает количество товаров на складе, издержки на хранение и другие характеристики.</p>
              
              <hr>
              <small class="md-content__copyright">
                
                This document was created with
                <a href="http://www.mkdocs.org">
                  MkDocs
                </a>
                and the
                <a href="http://squidfunk.github.io/mkdocs-material/">
                  Material
                </a>
                theme.
              </small>
            </article>
          </div>
        </div>
      </main>
      <footer class="md-footer">
  <div class="md-footer__inner">
    
      <nav class="md-footer-nav md-grid">
        
          <a href="../Bot/" title="Класс Bot" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--back md-footer-nav__icon"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Класс Bot
              </span>
            </div>
          </a>
        
        
      </nav>
    
  </div>
</footer>
    </div>
    <script src="../../assets/javascripts/application.js"></script>
    <script>
      /* Configuration for application */
      var config = {
        url: {
          base: "../..",
        },
        repo: {
          url: "",
          icon: "",
        },
        storage: window.sessionStorage,
      };
      /* Initialize application */
      var app = new Application(config);
      app.initialize();
    </script>
    
  </body>
</html>