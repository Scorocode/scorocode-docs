На закладке «Триггеры» вы можете создать описания для стандартных триггеров.

![Триггеры](../img/datatriggers.png)

Триггеры - скрипты на JavaScript, выполняемые при определенных операциях над данными. Все триггеры выполняются в замыканиях, имеют локальный контекст. Выберите триггер из предлагаемого списка и введите его описание в отведенном для этого окне. Для сохранения введенного описания нажмите на ссылку «Сохранить». Для активации созданного триггера установите опцию «Активировать». Без установки данной опции триггер не будет работать.

!!! warning "Ограничение времени работы"
    Максимальное время выполнения каждого триггера - 500 миллисекунд.

!!! warning "Ограничение стека вызовов"
    Максимальная глубина стека вызовов триггеров - 10.
    Пример:
    Если в триггере после операции "insert" выполнять операцию "insert" в эту же коллекцию, то будет вставлено 10 документов, после чего цепочка вызовов будет остановлена.

!!! warning "Прерывание/выполнение операций в результате работы триггера"
    При выполнении триггеров **перед** операциями "insert", "update" и "delete", необходимо в результате выполнять return true для продолжения выполнения операциий документа, и return false для прерывания выполнения операций. Если триггер не возвращает значения, то по умолчание результат его работы - false

!!! tip "Возврат данных при прерывании выполнения операции триггера"
    В случае, если вам необходимо при прерывании операции триггера вернуть данные - вы можете указать возвращаемые данне в параметре pool.result
    ```js
    if (!pool.doc.hasOwnProperty('name')) { // проверим наличие поля "name" в создаваемом документе
        pool.result = "Необходимо указать имя"
        return false;                     // прервем создание документа в случае отсутствия поля
    } 
    return true;                      // В случае, если значение поля присутствует - продолжим операцию
    ```


При выполнении триггера в его контексте создаются объекты `DataManager` и `pool`.

## Объект pool

Объект `pool` содержит следующие данные:

### Перед операцией `insert`:

```JSON
{
    doc : {}, // документ с парами имя_поля:значение
}
```

### После операции `insert`:

```JSON
{
    newDoc : {}, // вновь созданный документ с парами имя_поля:значение
}
```

### Перед операцией `remove`:

```JSON
{
    query : {}, // поисковый запрос, в соответствии с которым необходимо удалить документы
}
```

### После операции `remove`:

```JSON
{
    count : int // количество удаленных документов
    docs  : []  // массив ID удаленных документов
}
```

### Перед операцией `update`:

```JSON
{
    doc   : {}, // документ с правилами обновления значений
    query : {}, // поисковый запрос, в соответствии с которым необходимо обновить документы
}
```

### После операции `update`:

```JSON
{
    count : int // количество обновленный документов
    docs  : []  // массив ID обновленных документов
}
```

### Перед операцией `updatebyid`:

```JSON
{
    doc         : {}, // документ с правилами обновления значений
    query       : {}, // поисковый запрос {"_id" : }
}
```

### После операции `updatebyid`:

```JSON
{
    newDoc      : { } // обновленный документ
}
```

## Объект DataManager

Объект `DataManager` содержит следующие методы работы с данными:

### DataManager.Insert(data Object)

Метод для вставки документа в коллекцию. Параметры:

`data Object` - объект, содержащий следующие атрибуты:

```JSON
{
    coll : "", // имя коллекции, обязательный
    doc  : {}, // документ с парами имя_поля:значение, необязательный
}
```

Возвращаемое значение - `Object`:

*Выполнено*

```JSON
{
    error  : false
    result : {} // созданный документ
}
```

*Ошибка*

```JSON
{
    error   : true,
    errCode : 4XX/5XX, // Код ошибки
    errMsg  : "Текст ошибки"
}
```

### DataManager.Remove(data Object)

Метод для удаления документов из коллекции. Параметры:

`Data Object` - объект, содержащий следующие атрибуты:

```JSON
{
    coll  : "", // имя коллекции, обязательный
    query : {}, // запрос с парами имя_поля/оператор:значение, необязательный
    limit : int // лимит количества удаляемых документов, необязательный,
                // если не указан, то удалятся первые 1000 документов
}
```

Возвращаемое значение - `Object`:

*Выполнено*

```JSON
{
    error  : false
    result : {
        count : int, // количество удаленных документов
        docs  : [] // массив ID удаленных документов
    }
}
```

*Ошибка*

```JSON
{
    error   : true,
    errCode : 4XX/5XX, // Код ошибки
    errMsg  : "Текст ошибки"
}
```

### DataManager.Update(data Object)

Метод для обновления документов в коллекции. Параметры:

`Data Object` - объект, содержащий следующие атрибуты:

```JSON
{
    coll  : "", // имя коллекции, обязательный
    query : {}, // запрос с парами имя_поля/оператор:значение, необязательный
    doc   : {}, // документ с парами оператор:значение, обязательный
    limit : int // лимит количества обновляемых документов, необязательный,
                // если не указан, то обновятся первые 1000 документов
}
```

Возвращаемое значение - `Object`:

*Выполнено*

```JSON
{
    error  : false
    result : {
        count : int, // количество удаленных документов
        docs  : [] // массив ID измененных документов
    }
}
```

*Ошибка*

```JSON
{
    error   : true,
    errCode : 4XX/5XX, // Код ошибки
    errMsg  : "Текст ошибки"
}
```

### DataManager.UpdateById(data Object)

Метод для обновления одного документа в коллекции, идентифицируемого по ID. Параметры:

`data Object` - объект, содержащий следующие атрибуты:

```JSON
{
    coll  : "", // имя коллекции, обязательный
    query : {}, // запрос в формате "_id" : "<идентификатор документа>", обязательный
    doc   : {}, // документ с парами оператор:значение, обязательный
}
```

Возвращаемое значение - `Object`:

*Выполнено*

```JSON
{
    error  : false
    result : {} // обновленный документ
}
```

*Ошибка*

```JSON
{
    error   : true,
    errCode : 4XX/5XX, // Код ошибки
    errMsg  : "Текст ошибки"
}
```

### DataManager.Find(data Object)

Метод для запроса документов из коллекции. Параметры:

`data Object` - объект, содержащий следующие атрибуты:

```JSON
{
    coll   : "", // имя коллекции, обязательный
    query  : {}, // запрос с парами имя_поля/оператор:значение, необязательный, если пустой,
                 // то будут возвращены первые 100 документов
    sort   : {}, // сортировка по полям в формате имя_поля:1/-1, необязательный
    fields : [], // список имен полей, которые будут возвращены в каждом документе, необязательный
    limit  : int,// лимит размера выборки, необязательный, по умолчанию 50
    skip   : int,// количество документов, которое нужно пропустить в выборке
}
```

Возвращаемое значение - `Object`:

*Выполнено*

```JSON
{
    error  : false
    result : [] // массив выбранных документов с учетом лимита
}
```

*Ошибка*

```JSON
{
    error   : true,
    errCode : 4XX/5XX, // Код ошибки
    errMsg  : "Текст ошибки"
}
```

### DataManager.Count(data Object)
Метод для запроса количества документов по условию в коллекции. Параметры:

`data Object` - объект, содержащий следующие атрибуты:

```JSON
{
    coll  : "", // имя коллекции, обязательный
    query : {}, // запрос с парами имя_поля/оператор:значение, необязательный
}
```

Возвращаемое значение - `Object`:

*Выполнено*

```JSON
{
    error  : false
    result : int // количество документов
}
```

*Ошибка*

```JSON
{
    error   : true,
    errCode : 4XX/5XX, // Код ошибки
    errMsg  : "Текст ошибки"
}
```

### DataManager.RunScript(data Object)
Метод для запуска серверного скрипта. Параметры:

`data Object` - объект, содержащий следующие атрибуты:

```JSON
{
    script   : "", // ID скрипта, обязательный
    pool     : {}, // пул данных для установки передачи в контекст скрипта, необязательный
}
```

Возвращаемое значение - `Object`:

*ыполнено*

```JSON
{
    error  : false
}
```

*Ошибка*

```JSON
{
    error   : true,
    errCode : 4XX/5XX, // Код ошибки
    errMsg  : "Текст ошибки"
}
```

## Примеры триггеров

### Установка обязательности наличия значения поля.

Перед добавлением документа проверим наличие значения поля "name" и, в случае его отсутствия, прервем операцию добавления документа.

```js
if (!pool.doc.hasOwnProperty('name')) {   // проверим наличие поля "name" в создаваемом документе
        return false;                     // прервем создание документа в случае отсутствия поля
    } else {
        return true;                      // В случае, если значение поля присутствует - продолжим операцию
    };
```

### Установка значения по-умолчанию.

Перед добавлением документа проверим наличие значения поля "name" и, в случае его отсутствия, установим значение по-умолчанию.

```js
if (!pool.doc.hasOwnProperty('name')) { // проверим наличие поля "name" в создаваемом документе
        pool.doc.name = "Джон Сноу";    // в случае отсутствия значения, установим значение по-умолчанию
    }

return true;                    // В случае, если значение поля присутствует - продолжим операцию.
```

### Добавление связанного документа другой коллекции.

После добавления документа, создадим документ в другой коллекции со ссылкой на добавленный.

```js
DataManager.Insert({                           // выполним операцию добавления документа в коллекцию "stuff"
        coll : "stuff",
        doc  : {
                   "thing": pool.newDoc._id    // передадим _id созданного документа в поле типа "pointer"
        }
    })
```

### Удаление связанных документов другой коллекции.

Перед удалением документа, удалим все документы другой коллекции со ссылкой на удаляемый.

```js
DataManager.Remove({                           // выполним удаление связанных документов в коллекции "stuff"
    coll  : "stuff",
    query: {
        "thing": pool.query._id                // передадим _id удаляемого документа
    }
})
return true;
```

### Вызов серверного скрипта.

После добавления документа, запустим скрипт, передав ему новый документ. Скрипт может, например, осуществлять рассылку PUSH-уведомлений.

```js
DataManager.RunScript({                   // выполним запуск скрипта с ID 580b386d42d52f1ba275fc24
    script  : "580b386d42d52f1ba275fc24",
    pool: {
        "doc": pool.newDoc                // передадим новый документ
    }
})
```